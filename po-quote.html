<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PO Quote | Show Off Inc.</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Inter',-apple-system,'Helvetica Neue',sans-serif;background:#eaf0f6;min-height:100vh;padding:0;color:#33475b;font-size:14px;line-height:1.6;-webkit-font-smoothing:antialiased}

        .page-wrap{max-width:780px;margin:0 auto;padding:24px 16px 60px}
        .quote-card{background:#fff;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.1);overflow:hidden}

        /* Admin badge */
        .admin-bar{background:#f0f9ff;border-bottom:1px solid #d1ecf1;padding:8px 36px;font-size:12px;color:#0c5460;display:flex;align-items:center;gap:8px}
        .admin-dot{width:8px;height:8px;background:#17a2b8;border-radius:50%}

        /* ── Dark header banner ── */
        .header-banner{background:#2d3e50;color:#fff;padding:28px 36px 24px}
        .brand-text{font-size:20px;font-weight:700;color:#fff;margin-bottom:16px}

        .quote-title-wrap{margin-bottom:20px}
        .quote-title-input{width:100%;font-size:22px;font-weight:700;color:#fff;background:transparent;border:1.5px dashed rgba(255,255,255,0.3);border-radius:4px;padding:8px 12px;font-family:inherit;transition:all 0.15s}
        .quote-title-input:hover{border-color:rgba(255,255,255,0.5);background:rgba(255,255,255,0.06)}
        .quote-title-input:focus{outline:none;border-color:rgba(255,255,255,0.7);background:rgba(255,255,255,0.1);border-style:solid}
        .quote-title-input::placeholder{color:rgba(255,255,255,0.4)}

        .banner-info{display:flex;justify-content:space-between;gap:24px}
        .banner-left{flex:1}
        .banner-right{flex:0 0 auto;text-align:right}

        .dark-editable{width:100%;font-size:13px;color:#fff;background:transparent;border:1.5px dashed rgba(255,255,255,0.25);border-radius:3px;padding:5px 10px;font-family:inherit;transition:all 0.15s}
        .dark-editable:hover{border-color:rgba(255,255,255,0.45);background:rgba(255,255,255,0.06)}
        .dark-editable:focus{outline:none;border-color:rgba(255,255,255,0.7);background:rgba(255,255,255,0.1);border-style:solid}
        .dark-editable::placeholder{color:rgba(255,255,255,0.35)}
        textarea.dark-editable{resize:vertical;min-height:44px}

        .dark-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:rgba(255,255,255,0.5);margin-bottom:3px;margin-top:10px}
        .dark-label:first-child{margin-top:0}

        .banner-static{font-size:13px;color:rgba(255,255,255,0.85);line-height:1.5}
        .banner-static strong{color:#fff;font-weight:600}

        .address-row{display:flex;gap:8px;margin-top:2px}
        .dark-editable-sm{width:auto;font-size:13px;color:#fff;background:transparent;border:1.5px dashed rgba(255,255,255,0.25);border-radius:3px;padding:4px 8px;font-family:inherit;transition:all 0.15s}
        .dark-editable-sm:hover{border-color:rgba(255,255,255,0.45);background:rgba(255,255,255,0.06)}
        .dark-editable-sm:focus{outline:none;border-color:rgba(255,255,255,0.7);background:rgba(255,255,255,0.1);border-style:solid}
        .dark-editable-sm::placeholder{color:rgba(255,255,255,0.35)}
        .addr-city{flex:1;max-width:180px}
        .addr-state{flex:0 0 60px}
        .addr-zip{flex:0 0 80px}

        /* ── White content area ── */
        .content-area{padding:0 36px 32px}

        /* Comments section */
        .comments-section{padding:20px 0;border-bottom:1px solid #eaf0f6}
        .comments-label{font-size:13px;font-weight:700;color:#33475b;margin-bottom:8px}
        .light-editable{width:100%;font-size:14px;font-family:inherit;color:#33475b;line-height:1.6;padding:10px 12px;border:1.5px dashed #b8d4f0;border-radius:4px;background:#f7faff;resize:vertical;min-height:60px;transition:all 0.15s}
        .light-editable:hover{border-color:#7fb3e0}
        .light-editable:focus{outline:none;border-color:#4C76B8;background:#fff;border-style:solid;box-shadow:0 0 0 2px rgba(76,118,184,0.12)}
        .light-editable::placeholder{color:#b0c4de}

        /* Products table — EDITABLE */
        .products-heading{font-size:14px;font-weight:700;color:#33475b;padding:20px 0 12px}
        .products-table{width:100%;border-collapse:collapse}
        .products-table thead th{font-size:12px;font-weight:700;color:#33475b;padding:8px 4px;text-align:left;border-bottom:2px solid #33475b}
        .products-table thead th.qty{text-align:center;width:70px}
        .products-table thead th.price{text-align:right;width:100px}
        .products-table thead th.total{text-align:right;width:100px}
        .products-table thead th.actions{text-align:center;width:60px}
        .products-table tbody td{padding:8px 4px;border-bottom:1px solid #eaf0f6;vertical-align:middle}
        .products-table tbody tr.deleted{opacity:0.3}
        .products-table tbody tr.new td{background:#f0f9ff}
        .products-table input[type=text],.products-table input[type=number]{width:100%;padding:7px 8px;font-size:13px;font-family:inherit;border:1px solid #cbd6e2;border-radius:3px;background:#fff;color:#33475b}
        .products-table input:focus{outline:none;border-color:#4C76B8;box-shadow:0 0 0 2px rgba(76,118,184,0.12)}
        .products-table input:disabled{background:#f5f8fa;color:#99acc2}
        .qty-input{text-align:center;max-width:55px;margin:0 auto;display:block}
        .price-wrap{position:relative}
        .price-wrap .dollar{position:absolute;left:8px;top:50%;transform:translateY(-50%);color:#7c98b6;font-size:13px;pointer-events:none}
        .price-wrap input{padding-left:20px;text-align:right}
        .line-total{text-align:right;font-weight:600;font-size:14px;white-space:nowrap}
        .del-btn{padding:4px 8px;background:transparent;color:#7c98b6;border:1px solid #cbd6e2;border-radius:3px;cursor:pointer;font-size:10px;font-weight:600;font-family:inherit}
        .del-btn:hover{color:#d9534f;border-color:#d9534f}
        .add-row-btn{display:block;width:100%;padding:10px;background:transparent;color:#4C76B8;border:1.5px dashed #cbd6e2;border-radius:3px;cursor:pointer;font-size:13px;font-weight:500;font-family:inherit;margin-top:8px}
        .add-row-btn:hover{border-color:#4C76B8;background:rgba(76,118,184,0.04)}

        /* Subtotal + Total */
        .subtotal-row{display:flex;justify-content:flex-end;padding:10px 0;font-size:14px;color:#516f90}
        .subtotal-row span:last-child{min-width:100px;text-align:right}
        .total-row{display:flex;justify-content:flex-end;padding:10px 0;font-size:16px;font-weight:700;color:#33475b}
        .total-row span:last-child{min-width:100px;text-align:right}

        /* Purchase terms */
        .terms-section{padding:20px 0;border-top:1px solid #eaf0f6}
        .terms-label{font-size:14px;font-weight:700;color:#33475b;margin-bottom:8px}

        /* Contact notice */
        .contact-notice{padding:12px 0;border-top:1px solid #eaf0f6;font-size:13px;color:#516f90;text-align:center}
        .contact-notice strong{color:#33475b}

        /* Dual buttons */
        .btn-row{display:flex;gap:12px;padding:20px 0 0;border-top:1px solid #eaf0f6}
        .action-btn{flex:1;padding:12px 16px;font-size:14px;font-weight:600;font-family:inherit;border-radius:4px;cursor:pointer;transition:all 0.15s;border:none}
        .action-btn:disabled{opacity:0.5;cursor:not-allowed}
        .btn-draft{background:#fff;color:#33475b;border:1px solid #cbd6e2}
        .btn-draft:hover:not(:disabled){background:#f5f8fa;border-color:#33475b}
        .btn-send{background:#4C76B8;color:#fff}
        .btn-send:hover:not(:disabled){background:#3d6098}

        /* States */
        .loading-view{text-align:center;padding:100px 20px}
        .spinner{width:32px;height:32px;border:3px solid #eaf0f6;border-top-color:#4C76B8;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-view p{color:#7c98b6}

        .success-view{text-align:center;padding:80px 36px;display:none}
        .success-icon{width:56px;height:56px;margin:0 auto 20px;background:#d4edda;border-radius:50%;display:flex;align-items:center;justify-content:center}
        .success-icon svg{width:28px;height:28px;color:#155724}
        .success-view h2{font-size:18px;font-weight:700;color:#33475b;margin-bottom:8px}
        .success-view p{font-size:14px;color:#7c98b6;line-height:1.6}

        @media(max-width:600px){
            .page-wrap{padding:8px 4px 40px}
            .header-banner,.admin-bar{padding-left:20px;padding-right:20px}
            .content-area{padding:0 20px 24px}
            .banner-info{flex-direction:column;gap:16px}
            .banner-right{text-align:left}
            .address-row{flex-wrap:wrap}
            .btn-row{flex-direction:column}
        }
    </style>
</head>
<body>
    <div class="page-wrap">
        <div class="quote-card">
            <!-- Loading -->
            <div class="loading-view" id="loadingView">
                <div class="spinner"></div>
                <p>Loading deal data...</p>
            </div>

            <!-- ═══ MAIN QUOTE DOCUMENT ═══ -->
            <div id="mainView" style="display:none">

                <!-- Admin indicator -->
                <div class="admin-bar">
                    <span class="admin-dot"></span>
                    Internal view — edit line items and pre-fill quote details before sending to customer
                </div>

                <!-- ── Dark header banner ── -->
                <div class="header-banner">
                    <div class="brand-text">Trimsuits by Show Off Inc.</div>

                    <div class="quote-title-wrap">
                        <input type="text" class="quote-title-input" id="quoteTitle" placeholder="Quote title...">
                    </div>

                    <div class="banner-info">
                        <div class="banner-left">
                            <div class="dark-label">Company / School</div>
                            <input type="text" class="dark-editable" id="schoolName" placeholder="e.g. UGA Majorettes" style="max-width:320px">

                            <div class="dark-label">Attention</div>
                            <textarea class="dark-editable" id="attentionLine" rows="2" placeholder="e.g. Att: Ashley Clark, 2025-2026 Uniforms, 250 River Road"></textarea>

                            <div class="dark-label">Mailing Address</div>
                            <div class="address-row">
                                <input type="text" class="dark-editable-sm addr-city" id="addrCity" placeholder="City">
                                <input type="text" class="dark-editable-sm addr-state" id="addrState" placeholder="State">
                                <input type="text" class="dark-editable-sm addr-zip" id="addrZip" placeholder="ZIP">
                            </div>
                            <input type="text" class="dark-editable-sm" id="addrCountry" placeholder="Country" style="margin-top:4px;width:180px" value="United States">
                        </div>

                        <div class="banner-right">
                            <div class="banner-static" id="contactLine"></div>
                            <div class="banner-static" id="contactEmailLine"></div>
                            <div class="banner-static" style="margin-top:8px"><span class="status-badge" id="quoteBadge"></span></div>
                            <div class="banner-static" id="metaDate" style="margin-top:8px"></div>
                        </div>
                    </div>
                </div>

                <!-- ── White content area ── -->
                <div class="content-area">

                    <!-- Comments from rep -->
                    <div class="comments-section">
                        <div class="comments-label">Comments for PO Issuer</div>
                        <textarea class="light-editable" id="quoteNotes" placeholder="Comments for the customer's finance department..."></textarea>
                    </div>

                    <!-- Products & Services (EDITABLE) -->
                    <div class="products-heading">Products &amp; Services</div>
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>Item &amp; Description</th>
                                <th class="qty">Qty</th>
                                <th class="price">Unit Price</th>
                                <th class="total">Total</th>
                                <th class="actions"></th>
                            </tr>
                        </thead>
                        <tbody id="lineItems"></tbody>
                    </table>
                    <button type="button" class="add-row-btn" onclick="addItem()">+ Add Line Item</button>

                    <div class="subtotal-row"><span>One-time subtotal</span><span id="subtotal">$0.00</span></div>
                    <div class="total-row"><span>Total</span><span id="totalAmount">$0.00</span></div>

                    <!-- Purchase terms -->
                    <div class="terms-section">
                        <div class="terms-label">Purchase terms</div>
                        <textarea class="light-editable" id="purchaseTerms" placeholder="Payment terms, conditions, etc..."></textarea>
                    </div>

                    <!-- Contact notice -->
                    <div class="contact-notice" id="contactInfo" style="display:none">
                        Review link will be sent to <strong id="contactName"></strong> at <strong id="contactEmail"></strong>
                    </div>

                    <!-- Action buttons -->
                    <div class="btn-row">
                        <button class="action-btn btn-draft" id="draftBtn" onclick="handleSubmit('save')">Save Draft</button>
                        <button class="action-btn btn-send" id="sendBtn" onclick="handleSubmit('send-review')">Send to Customer</button>
                    </div>
                </div>
            </div>

            <!-- Success -->
            <div class="success-view" id="successView">
                <div class="success-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>
                </div>
                <h2 id="successTitle">Done</h2>
                <p id="successMessage"></p>
            </div>
        </div>
    </div>

    <script>
        var urlParams = new URLSearchParams(window.location.search);
        var dealId = urlParams.get('dealId');
        var dealData = null;
        var itemIndex = 0;
        var deletedIds = [];

        if (!dealId) {
            document.getElementById('loadingView').innerHTML = '<p style="color:#d9534f;padding:100px 20px;">Error: No dealId provided in URL</p>';
        } else {
            loadData();
        }

        async function loadData() {
            try {
                var res = await fetch('/api/po-quote?dealId=' + dealId);
                if (!res.ok) throw new Error('Failed to fetch');
                dealData = await res.json();
                var v = dealData.verbiage || {};

                // Header fields
                document.getElementById('quoteTitle').value = dealData.poFields.title || dealData.dealName || '';
                document.getElementById('schoolName').value = v.schoolName || '';
                document.getElementById('attentionLine').value = dealData.poFields.addressee || '';
                document.getElementById('addrCity').value = v.mailingCity || '';
                document.getElementById('addrState').value = v.mailingState || '';
                document.getElementById('addrZip').value = v.mailingZip || '';
                document.getElementById('addrCountry').value = v.mailingCountry || 'United States';

                // Right side
                if (dealData.primaryContact) {
                    document.getElementById('contactLine').innerHTML = '<strong>' + esc(dealData.primaryContact.name) + '</strong>';
                    document.getElementById('contactEmailLine').textContent = dealData.primaryContact.email;
                }

                var badge = document.getElementById('quoteBadge');
                if (dealData.existingQuote) {
                    badge.textContent = dealData.existingQuote.status === 'DRAFT' ? 'DRAFT' : 'PUBLISHED';
                    badge.style.cssText = 'display:inline-block;padding:3px 8px;border-radius:3px;font-size:10px;font-weight:700;letter-spacing:0.05em;' +
                        (dealData.existingQuote.status === 'DRAFT' ? 'background:rgba(255,193,7,0.2);color:#ffc107' : 'background:rgba(40,167,69,0.2);color:#28a745');
                } else {
                    badge.textContent = 'NEW';
                    badge.style.cssText = 'display:inline-block;padding:3px 8px;border-radius:3px;font-size:10px;font-weight:700;letter-spacing:0.05em;background:rgba(23,162,184,0.2);color:#17a2b8';
                }

                document.getElementById('metaDate').textContent = formatDate(new Date());

                // Comments
                document.getElementById('quoteNotes').value = dealData.poFields.notes || '';

                // Line items
                var container = document.getElementById('lineItems');
                dealData.lineItems.forEach(function(item, i) {
                    container.innerHTML += lineItemHtml(i, item.id, item.name, item.quantity, item.price);
                    itemIndex = i + 1;
                });

                // Purchase terms
                document.getElementById('purchaseTerms').value = v.purchaseTerms || '';

                // Contact notice
                if (dealData.primaryContact) {
                    document.getElementById('contactName').textContent = dealData.primaryContact.name;
                    document.getElementById('contactEmail').textContent = dealData.primaryContact.email;
                    document.getElementById('contactInfo').style.display = 'block';
                }

                updateTotal();
                document.getElementById('loadingView').style.display = 'none';
                document.getElementById('mainView').style.display = 'block';
            } catch (err) {
                document.getElementById('loadingView').innerHTML =
                    '<p style="color:#d9534f;padding:100px 20px;">Error loading deal: ' + esc(err.message) + '</p>';
            }
        }

        function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
        function formatDate(d) {
            var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            return months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
        }
        function formatNum(n) {
            return Number(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function lineItemHtml(idx, id, name, qty, price) {
            var lineTotal = (parseFloat(qty)||1) * (parseFloat(price)||0);
            var isNew = id === 'new';
            return '<tr class="' + (isNew ? 'new' : '') + '" data-id="' + id + '">' +
                '<td><input type="text" data-field="name" value="' + esc(name) + '" placeholder="Item name"></td>' +
                '<td><input type="number" class="qty-input" data-field="qty" value="' + (qty||1) + '" min="1" step="1" onchange="updateTotal()" oninput="updateTotal()"></td>' +
                '<td><div class="price-wrap"><span class="dollar">$</span><input type="number" data-field="price" value="' + (price||'') + '" min="0" step="0.01" onchange="updateTotal()" oninput="updateTotal()"></div></td>' +
                '<td class="line-total" data-field="line-total">$' + formatNum(lineTotal) + '</td>' +
                '<td style="text-align:center"><button type="button" class="del-btn" onclick="deleteItem(this)">Del</button></td></tr>';
        }

        function addItem() {
            var container = document.getElementById('lineItems');
            container.insertAdjacentHTML('beforeend', lineItemHtml(itemIndex, 'new', '', 1, ''));
            itemIndex++;
            updateTotal();
            container.lastElementChild.querySelector('input[data-field="name"]').focus();
        }

        function deleteItem(btn) {
            var row = btn.closest('tr');
            var id = row.dataset.id;
            if (id && id !== 'new') {
                deletedIds.push(id);
                row.classList.add('deleted');
                row.querySelectorAll('input').forEach(function(i){i.disabled=true});
                btn.textContent = 'Undo';
                btn.onclick = function(){ undoDelete(btn, id); };
            } else {
                row.remove();
            }
            updateTotal();
        }

        function undoDelete(btn, id) {
            var row = btn.closest('tr');
            deletedIds = deletedIds.filter(function(i){return i !== id});
            row.classList.remove('deleted');
            row.querySelectorAll('input').forEach(function(i){i.disabled=false});
            btn.textContent = 'Del';
            btn.onclick = function(){ deleteItem(btn); };
            updateTotal();
        }

        function updateTotal() {
            var total = 0;
            document.querySelectorAll('#lineItems tr:not(.deleted)').forEach(function(row) {
                var qty = parseFloat(row.querySelector('[data-field="qty"]').value) || 1;
                var price = parseFloat(row.querySelector('[data-field="price"]').value) || 0;
                var lineTotal = qty * price;
                total += lineTotal;
                row.querySelector('[data-field="line-total"]').textContent = '$' + formatNum(lineTotal);
            });
            document.getElementById('subtotal').textContent = '$' + formatNum(total);
            document.getElementById('totalAmount').textContent = '$' + formatNum(total);
        }

        async function handleSubmit(action) {
            var draftBtn = document.getElementById('draftBtn');
            var sendBtn = document.getElementById('sendBtn');
            draftBtn.disabled = true;
            sendBtn.disabled = true;
            if (action === 'save') draftBtn.textContent = 'Saving...';
            else sendBtn.textContent = 'Sending...';

            var items = [];
            document.querySelectorAll('#lineItems tr:not(.deleted)').forEach(function(row) {
                items.push({
                    id: row.dataset.id,
                    name: row.querySelector('[data-field="name"]').value,
                    quantity: row.querySelector('[data-field="qty"]').value,
                    price: row.querySelector('[data-field="price"]').value
                });
            });

            var payload = {
                action: action,
                dealId: dealId,
                dealName: dealData.dealName,
                items: items,
                deletedItems: deletedIds,
                existingQuoteId: dealData.existingQuote ? dealData.existingQuote.id : null,
                // Existing PO fields
                addressee: document.getElementById('attentionLine').value,
                quoteTitle: document.getElementById('quoteTitle').value || dealData.dealName,
                quoteNotes: document.getElementById('quoteNotes').value,
                // Verbiage JSON (presentation-only)
                verbiage: {
                    schoolName: document.getElementById('schoolName').value,
                    mailingCity: document.getElementById('addrCity').value,
                    mailingState: document.getElementById('addrState').value,
                    mailingZip: document.getElementById('addrZip').value,
                    mailingCountry: document.getElementById('addrCountry').value,
                    purchaseTerms: document.getElementById('purchaseTerms').value,
                    commentsBy: 'Erica Fenn'
                },
                // Contact
                contactEmail: dealData.primaryContact ? dealData.primaryContact.email : null,
                contactName: dealData.primaryContact ? dealData.primaryContact.name : null,
                contactId: dealData.primaryContact ? dealData.primaryContact.id : null
            };

            try {
                var res = await fetch('https://showoffinc.app.n8n.cloud/webhook/process-po-quote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    document.getElementById('mainView').style.display = 'none';
                    if (action === 'save') {
                        document.getElementById('successTitle').textContent = 'Draft Saved';
                        document.getElementById('successMessage').textContent =
                            'Line items, quote details, and presentation fields saved to the deal. No emails sent.';
                    } else {
                        document.getElementById('successTitle').textContent = 'Review Link Sent';
                        var msg = 'A secure review link has been sent';
                        if (dealData.primaryContact) msg += ' to ' + dealData.primaryContact.name + ' at ' + dealData.primaryContact.email;
                        msg += '. The customer can review and finalize the quote.';
                        document.getElementById('successMessage').textContent = msg;
                    }
                    document.getElementById('successView').style.display = 'block';
                } else {
                    throw new Error('Server error');
                }
            } catch (err) {
                alert('Error: ' + err.message + '. Please try again.');
                draftBtn.disabled = false;
                sendBtn.disabled = false;
                draftBtn.textContent = 'Save Draft';
                sendBtn.textContent = 'Send to Customer';
            }
        }
    </script>
</body>
</html>
