<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PO Quote | Show Off Inc.</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Inter',-apple-system,sans-serif;background:#faf9f7;min-height:100vh;padding:20px;color:#2a2220;font-size:13px;line-height:1.5}

        .quote-doc{max-width:680px;margin:0 auto;background:rgba(255,255,255,0.82);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.3);box-shadow:0 8px 32px rgba(0,0,0,0.08);border-radius:2px;padding:48px 40px 36px}

        /* Logo + Header */
        .doc-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:32px;padding-bottom:20px;border-bottom:1.5px solid rgba(42,34,32,0.1)}
        .brand{display:flex;flex-direction:column}
        .brand-name{font-family:'Cormorant Garamond',Georgia,serif;font-size:22px;font-weight:600;letter-spacing:0.06em;color:#2a2220}
        .brand-sub{font-size:9px;letter-spacing:0.2em;text-transform:uppercase;color:#999;margin-top:2px}
        .doc-type{text-align:right}
        .doc-type h1{font-family:'Cormorant Garamond',Georgia,serif;font-size:26px;font-weight:500;letter-spacing:0.04em;color:#2a2220}
        .doc-type .deal-num{font-size:10px;letter-spacing:0.12em;text-transform:uppercase;color:#999;margin-top:4px}

        /* Status badge */
        .quote-badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:10px;font-weight:500;letter-spacing:0.05em}
        .quote-badge.draft{background:rgba(200,170,100,0.15);color:#8b7355}
        .quote-badge.published{background:rgba(76,175,80,0.12);color:#2e7d32}
        .quote-badge.new{background:rgba(33,150,243,0.12);color:#1565c0}

        /* Meta row */
        .meta-row{display:flex;justify-content:space-between;margin-bottom:28px;padding:14px 18px;background:linear-gradient(145deg,rgba(255,252,248,0.9),rgba(248,245,240,0.7));border:1px solid rgba(200,180,170,0.15);border-radius:2px}
        .meta-item{display:flex;flex-direction:column}
        .meta-label{font-size:8px;letter-spacing:0.25em;text-transform:uppercase;color:#999;margin-bottom:3px}
        .meta-value{font-size:12px;color:#2a2220}

        /* Line items — editable grid */
        .section-label{font-size:8px;letter-spacing:0.25em;text-transform:uppercase;color:#999;margin-bottom:10px;margin-top:0}
        .column-headers{display:grid;grid-template-columns:1fr 70px 100px 100px 50px;gap:8px;padding:0 14px 8px;font-size:8px;color:#999;letter-spacing:0.2em;text-transform:uppercase}
        .line-items{display:flex;flex-direction:column;gap:8px}
        .line-item{display:grid;grid-template-columns:1fr 70px 100px 100px 50px;gap:8px;align-items:center;padding:12px 14px;background:linear-gradient(145deg,rgba(255,255,255,0.92),rgba(255,252,250,0.88));border-radius:2px;border:1px solid rgba(200,180,170,0.15)}
        .line-item.new{background:linear-gradient(145deg,rgba(255,252,250,0.6),rgba(248,245,242,0.5))}
        .line-item.deleted{opacity:0.35}
        .line-total{text-align:right;font-size:13px;font-weight:500;color:#2a2220}

        input[type=text],input[type=number],input[type=url],textarea{width:100%;padding:10px 12px;font-size:13px;font-family:'Inter',sans-serif;border:1px solid rgba(200,180,170,0.25);border-radius:2px;background:rgba(255,255,255,0.6);color:#2a2220;transition:border-color 0.2s}
        input:focus,textarea:focus{outline:none;border-color:rgba(200,170,155,0.6);box-shadow:0 0 0 3px rgba(200,170,155,0.1);background:rgba(255,255,255,0.95)}
        textarea{resize:vertical;min-height:80px}
        .qty-field input{text-align:center;padding:10px 6px}
        .price-field{position:relative;display:flex;align-items:center}
        .price-field .dollar{position:absolute;left:10px;color:#888;font-size:13px}
        .price-field input{padding-left:22px}

        .delete-btn{padding:8px 10px;background:transparent;color:#aaa;border:1px solid rgba(200,180,170,0.15);border-radius:2px;cursor:pointer;font-size:8px;letter-spacing:0.1em;text-transform:uppercase;font-family:'Inter',sans-serif;transition:all 0.2s}
        .delete-btn:hover{color:#c62828;border-color:#c62828}
        .add-btn{width:100%;padding:12px;background:transparent;color:#2a2220;border:1.5px dashed rgba(200,180,170,0.35);border-radius:2px;cursor:pointer;font-size:12px;font-family:'Cormorant Garamond',Georgia,serif;letter-spacing:0.04em;margin-top:8px}
        .add-btn:hover{border-color:#2a2220}

        /* Totals */
        .totals-section{margin-top:16px;padding:16px 18px;background:linear-gradient(145deg,rgba(255,255,255,0.92),rgba(255,252,250,0.88));border:1.5px solid rgba(42,34,32,0.2);border-radius:2px}
        .total-row{display:flex;justify-content:space-between;padding:4px 0}
        .total-row .label{font-size:11px;color:#888}
        .total-row .amount{font-size:14px;color:#2a2220}
        .total-row.grand{padding-top:10px;margin-top:8px;border-top:1px solid rgba(200,180,170,0.2)}
        .total-row.grand .label{font-size:13px;font-weight:500;color:#2a2220}
        .total-row.grand .amount{font-family:'Cormorant Garamond',Georgia,serif;font-size:22px;font-weight:600}

        /* Quote details section */
        .details-section{margin-top:28px;padding:24px 20px;background:linear-gradient(145deg,rgba(255,248,230,0.45),rgba(255,252,240,0.35));border:1.5px solid rgba(200,170,100,0.25);border-radius:2px}
        .details-section h3{font-family:'Cormorant Garamond',Georgia,serif;font-size:16px;font-weight:500;margin-bottom:4px}
        .details-section p{font-size:11px;color:#8b7355;margin-bottom:16px}
        .field-group{margin-top:16px}
        .field-group:first-of-type{margin-top:0}
        .field-label{display:block;font-family:'Cormorant Garamond',Georgia,serif;font-size:14px;font-weight:500;color:#2a2220;margin-bottom:6px}
        .field-hint{font-size:10px;color:#aaa;margin-top:4px;font-style:italic}

        /* Contact info */
        .contact-notice{margin-top:20px;padding:12px 16px;background:rgba(42,34,32,0.03);border:1px solid rgba(42,34,32,0.06);border-radius:2px;font-size:12px;color:#666;text-align:center}
        .contact-notice strong{color:#2a2220}

        /* Dual action buttons */
        .btn-row{display:flex;gap:12px;margin-top:24px}
        .action-btn{flex:1;padding:18px 16px;font-size:15px;font-weight:500;font-family:'Cormorant Garamond',Georgia,serif;letter-spacing:0.04em;border:2px solid #2a2220;border-radius:2px;cursor:pointer;transition:all 0.2s}
        .action-btn:disabled{opacity:0.5;cursor:not-allowed}
        .btn-draft{background:transparent;color:#2a2220}
        .btn-draft:hover:not(:disabled){background:rgba(42,34,32,0.06)}
        .btn-send{background:#2a2220;color:#fff}
        .btn-send:hover:not(:disabled){background:#1a1510}

        /* States */
        .loading{display:none;text-align:center;padding:60px 20px}
        .loading.active{display:block}
        .spinner{width:32px;height:32px;border:2px solid rgba(42,34,32,0.1);border-top-color:#2a2220;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .success-view{display:none;text-align:center;padding:60px 20px}
        .success-view.active{display:block}
        .success-icon{width:64px;height:64px;margin:0 auto 20px;color:#2e7d32}
        .success-title{font-family:'Cormorant Garamond',Georgia,serif;font-size:22px;margin-bottom:12px}
        .success-message{font-size:13px;color:#666;line-height:1.6}

        .footer{text-align:center;padding-top:24px;font-size:10px;color:#aaa;letter-spacing:0.08em}

        @media(max-width:600px){
            .quote-doc{padding:28px 20px 24px}
            .doc-header{flex-direction:column;gap:12px}
            .doc-type{text-align:left}
            .meta-row{flex-direction:column;gap:10px}
            .column-headers,.line-item{grid-template-columns:1fr 55px 80px 80px 40px}
            .btn-row{flex-direction:column;gap:8px}
        }
    </style>
</head>
<body>
    <div class="quote-doc">
        <!-- Loading -->
        <div class="loading" id="loadingView">
            <div class="spinner"></div>
            <p>Loading deal data...</p>
        </div>

        <!-- Main content -->
        <div id="mainView" style="display:none">
            <!-- Header -->
            <div class="doc-header">
                <div class="brand">
                    <div class="brand-name">Show Off Inc.</div>
                    <div class="brand-sub">Custom Performance Wear</div>
                </div>
                <div class="doc-type">
                    <h1>Quote</h1>
                    <div class="deal-num" id="dealNum"></div>
                </div>
            </div>

            <!-- Meta -->
            <div class="meta-row">
                <div class="meta-item">
                    <span class="meta-label">Contact</span>
                    <span class="meta-value" id="metaContact">—</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Status</span>
                    <span class="meta-value"><span class="quote-badge" id="quoteBadge"></span></span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Date</span>
                    <span class="meta-value" id="metaDate"></span>
                </div>
            </div>

            <!-- Line Items (editable) -->
            <div class="section-label">Line Items</div>
            <div class="column-headers"><span>Item</span><span>Qty</span><span>Price</span><span>Total</span><span></span></div>
            <div class="line-items" id="lineItems"></div>
            <button type="button" class="add-btn" onclick="addItem()">+ Add Line Item</button>

            <!-- Totals -->
            <div class="totals-section">
                <div class="total-row"><span class="label">Subtotal</span><span class="amount" id="subtotal">$0.00</span></div>
                <div class="total-row grand"><span class="label">Total</span><span class="amount" id="totalAmount">$0.00</span></div>
            </div>

            <!-- Quote Details -->
            <div class="details-section">
                <h3>Quote Details</h3>
                <p>Custom text for the school's finance department</p>
                <div class="field-group">
                    <label class="field-label" for="quoteTitle">Quote Title</label>
                    <input type="text" id="quoteTitle" placeholder="e.g. Jefferson County ISD — Twirling Team">
                    <div class="field-hint">Defaults to deal name if left blank</div>
                </div>
                <div class="field-group">
                    <label class="field-label" for="addressee">Attention</label>
                    <input type="text" id="addressee" placeholder="e.g. Jane Smith, Procurement Dept">
                    <div class="field-hint">Who this quote is addressed to</div>
                </div>
                <div class="field-group">
                    <label class="field-label" for="quoteNotes">Special Notes</label>
                    <textarea id="quoteNotes" placeholder="Any special verbiage the finance department requested..."></textarea>
                    <div class="field-hint">Appears on the quote as a note</div>
                </div>
            </div>

            <!-- Contact Preview -->
            <div class="contact-notice" id="contactInfo" style="display:none">
                Review link will be sent to <strong id="contactName"></strong> at <strong id="contactEmail"></strong>
            </div>

            <!-- Dual Buttons -->
            <div class="btn-row">
                <button class="action-btn btn-draft" id="draftBtn" onclick="handleSubmit('save')">Save Draft</button>
                <button class="action-btn btn-send" id="sendBtn" onclick="handleSubmit('send-review')">Send to Customer</button>
            </div>
        </div>

        <!-- Success -->
        <div class="success-view" id="successView">
            <div class="success-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="64" height="64">
                    <path d="M5 13l4 4L19 7"/>
                </svg>
            </div>
            <h2 class="success-title" id="successTitle">Done</h2>
            <p class="success-message" id="successMessage"></p>
        </div>

        <div class="footer">Show Off Inc.</div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const dealId = urlParams.get('dealId');
        let dealData = null;
        let itemIndex = 0;
        let deletedIds = [];

        if (!dealId) {
            document.getElementById('loadingView').innerHTML = '<p style="color:#c62828">Error: No dealId provided in URL</p>';
            document.getElementById('loadingView').classList.add('active');
        } else {
            document.getElementById('loadingView').classList.add('active');
            loadData();
        }

        async function loadData() {
            try {
                const res = await fetch(`/api/po-quote?dealId=${dealId}`);
                if (!res.ok) throw new Error('Failed to fetch');
                dealData = await res.json();

                // Header
                const dealNum = dealData.dealName.split(' ')[0];
                document.getElementById('dealNum').textContent = `Order #${dealNum}`;

                // Meta
                if (dealData.primaryContact) {
                    document.getElementById('metaContact').textContent =
                        dealData.primaryContact.name + ' (' + dealData.primaryContact.email + ')';
                }
                document.getElementById('metaDate').textContent = formatDate(new Date());

                // Status badge
                const badge = document.getElementById('quoteBadge');
                if (dealData.existingQuote) {
                    badge.textContent = dealData.existingQuote.status === 'DRAFT' ? 'Draft' : 'Published';
                    badge.className = 'quote-badge ' + (dealData.existingQuote.status === 'DRAFT' ? 'draft' : 'published');
                } else {
                    badge.textContent = 'New';
                    badge.className = 'quote-badge new';
                }

                // Line items
                const container = document.getElementById('lineItems');
                dealData.lineItems.forEach(function(item, i) {
                    container.innerHTML += lineItemHtml(i, item.id, item.name, item.quantity, item.price);
                    itemIndex = i + 1;
                });

                // Verbiage
                document.getElementById('addressee').value = dealData.poFields.addressee || '';
                document.getElementById('quoteTitle').value = dealData.poFields.title || '';
                document.getElementById('quoteNotes').value = dealData.poFields.notes || '';

                // Contact
                if (dealData.primaryContact) {
                    document.getElementById('contactName').textContent = dealData.primaryContact.name;
                    document.getElementById('contactEmail').textContent = dealData.primaryContact.email;
                    document.getElementById('contactInfo').style.display = 'block';
                }

                updateTotal();
                document.getElementById('loadingView').classList.remove('active');
                document.getElementById('mainView').style.display = 'block';
            } catch (err) {
                document.getElementById('loadingView').innerHTML =
                    '<p style="color:#c62828">Error loading deal: ' + esc(err.message) + '</p>';
            }
        }

        function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

        function formatDate(d) {
            var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            return months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
        }

        function lineItemHtml(idx, id, name, qty, price) {
            var lineTotal = (parseFloat(qty)||1) * (parseFloat(price)||0);
            return '<div class="line-item' + (id === 'new' ? ' new' : '') + '" data-id="' + id + '">' +
                '<input type="text" data-field="name" value="' + esc(name) + '" placeholder="Item name">' +
                '<div class="qty-field"><input type="number" data-field="qty" value="' + (qty||1) + '" min="1" step="1" onchange="updateTotal()" oninput="updateTotal()"></div>' +
                '<div class="price-field"><span class="dollar">$</span><input type="number" data-field="price" value="' + (price||'') + '" min="0" step="0.01" onchange="updateTotal()" oninput="updateTotal()"></div>' +
                '<div class="line-total" data-field="line-total">$' + lineTotal.toFixed(2) + '</div>' +
                '<button type="button" class="delete-btn" onclick="deleteItem(this)">Delete</button></div>';
        }

        function addItem() {
            var container = document.getElementById('lineItems');
            container.insertAdjacentHTML('beforeend', lineItemHtml(itemIndex, 'new', '', 1, ''));
            itemIndex++;
            updateTotal();
            container.lastElementChild.querySelector('input[data-field="name"]').focus();
        }

        function deleteItem(btn) {
            var item = btn.closest('.line-item');
            var id = item.dataset.id;
            if (id && id !== 'new') {
                deletedIds.push(id);
                item.classList.add('deleted');
                item.querySelectorAll('input').forEach(function(i){i.disabled=true});
                btn.textContent = 'Undo';
                btn.onclick = function(){ undoDelete(btn, id); };
            } else {
                item.remove();
            }
            updateTotal();
        }

        function undoDelete(btn, id) {
            var item = btn.closest('.line-item');
            deletedIds = deletedIds.filter(function(i){return i !== id});
            item.classList.remove('deleted');
            item.querySelectorAll('input').forEach(function(i){i.disabled=false});
            btn.textContent = 'Delete';
            btn.onclick = function(){ deleteItem(btn); };
            updateTotal();
        }

        function updateTotal() {
            var total = 0;
            document.querySelectorAll('.line-item:not(.deleted)').forEach(function(item) {
                var qty = parseFloat(item.querySelector('[data-field="qty"]').value) || 1;
                var price = parseFloat(item.querySelector('[data-field="price"]').value) || 0;
                var lineTotal = qty * price;
                total += lineTotal;
                item.querySelector('[data-field="line-total"]').textContent = '$' + lineTotal.toFixed(2);
            });
            document.getElementById('subtotal').textContent = '$' + total.toFixed(2);
            document.getElementById('totalAmount').textContent = '$' + total.toFixed(2);
        }

        async function handleSubmit(action) {
            var draftBtn = document.getElementById('draftBtn');
            var sendBtn = document.getElementById('sendBtn');
            draftBtn.disabled = true;
            sendBtn.disabled = true;

            if (action === 'save') {
                draftBtn.textContent = 'Saving...';
            } else {
                sendBtn.textContent = 'Sending...';
            }

            var items = [];
            document.querySelectorAll('.line-item:not(.deleted)').forEach(function(item) {
                items.push({
                    id: item.dataset.id,
                    name: item.querySelector('[data-field="name"]').value,
                    quantity: item.querySelector('[data-field="qty"]').value,
                    price: item.querySelector('[data-field="price"]').value
                });
            });

            var payload = {
                action: action,
                dealId: dealId,
                dealName: dealData.dealName,
                items: items,
                deletedItems: deletedIds,
                existingQuoteId: dealData.existingQuote ? dealData.existingQuote.id : null,
                addressee: document.getElementById('addressee').value,
                quoteTitle: document.getElementById('quoteTitle').value || dealData.dealName,
                quoteNotes: document.getElementById('quoteNotes').value,
                contactEmail: dealData.primaryContact ? dealData.primaryContact.email : null,
                contactName: dealData.primaryContact ? dealData.primaryContact.name : null,
                contactId: dealData.primaryContact ? dealData.primaryContact.id : null
            };

            try {
                var res = await fetch('https://showoffinc.app.n8n.cloud/webhook/process-po-quote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    document.getElementById('mainView').style.display = 'none';

                    if (action === 'save') {
                        document.getElementById('successTitle').textContent = 'Draft Saved';
                        document.getElementById('successMessage').textContent =
                            'Line items and quote details saved to the deal. No emails sent.';
                    } else {
                        document.getElementById('successTitle').textContent = 'Review Link Sent';
                        var msg = 'A secure review link has been sent';
                        if (dealData.primaryContact) {
                            msg += ' to ' + dealData.primaryContact.name + ' at ' + dealData.primaryContact.email;
                        }
                        msg += '. The customer can review line items and finalize the quote.';
                        document.getElementById('successMessage').textContent = msg;
                    }
                    document.getElementById('successView').classList.add('active');
                } else {
                    throw new Error('Server error');
                }
            } catch (err) {
                alert('Error: ' + err.message + '. Please try again.');
                draftBtn.disabled = false;
                sendBtn.disabled = false;
                draftBtn.textContent = 'Save Draft';
                sendBtn.textContent = 'Send to Customer';
            }
        }
    </script>
</body>
</html>
