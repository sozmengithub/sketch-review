<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quote Review | Show Off Inc.</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Avenir+Next:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Avenir Next',-apple-system,'Helvetica Neue',Helvetica,Arial,sans-serif;background:#fff;color:#33475b;font-size:14px;line-height:1.6;-webkit-font-smoothing:antialiased}

        .quote-page{max-width:740px;margin:0 auto;padding:40px 32px 60px}

        /* Company header */
        .company-header{font-size:22px;font-weight:700;color:#4C76B8;margin-bottom:24px;letter-spacing:-0.01em}

        /* Quote title */
        .quote-title{text-align:center;font-size:22px;font-weight:600;color:#33475b;margin-bottom:32px}
        .quote-title .editable-title{font-size:22px;font-weight:600;color:#33475b;text-align:center;border:none;background:transparent;width:100%;font-family:inherit;padding:6px 8px;border-radius:3px;border:1.5px dashed transparent;transition:all 0.15s}
        .quote-title .editable-title:hover{border-color:#b8d4f0;background:#f7faff}
        .quote-title .editable-title:focus{outline:none;border-color:#4C76B8;background:#fff;box-shadow:0 0 0 2px rgba(76,118,184,0.12)}
        .edit-hint{font-size:10px;color:#99acc2;text-align:center;margin-top:2px;opacity:0;transition:opacity 0.15s}
        .quote-title:hover .edit-hint{opacity:1}

        /* Two-column info */
        .info-row{display:flex;justify-content:space-between;margin-bottom:24px;gap:40px}
        .info-left{flex:1}
        .info-right{flex:0 0 auto;text-align:right}
        .contact-name{font-weight:600;font-size:14px;color:#33475b}
        .contact-detail{font-size:13px;color:#516f90}
        .ref-line{font-size:13px;color:#516f90;margin-top:12px}
        .company-right{font-weight:600;font-size:14px;color:#33475b}
        .prepared-by{margin-top:12px;font-size:13px;color:#516f90}
        .prepared-by strong{color:#33475b;font-weight:600}

        /* PO Number field inline */
        .po-line{margin-top:8px;font-size:13px;color:#516f90;display:flex;align-items:center;gap:6px}
        .po-line label{white-space:nowrap}
        .po-input{font-size:13px;font-family:inherit;color:#33475b;padding:3px 8px;border:1.5px dashed #b8d4f0;border-radius:3px;background:#f7faff;width:200px;transition:all 0.15s}
        .po-input:hover{border-color:#7fb3e0}
        .po-input:focus{outline:none;border-color:#4C76B8;background:#fff;border-style:solid;box-shadow:0 0 0 2px rgba(76,118,184,0.12)}
        .po-input::placeholder{color:#b0c4de}

        /* Total line */
        .total-header{display:flex;justify-content:space-between;align-items:baseline;padding:16px 0;border-top:2px solid #33475b;border-bottom:1px solid #cbd6e2;margin-bottom:24px}
        .total-header .t-label{font-size:16px;font-weight:600;color:#33475b}
        .total-header .t-amount{font-size:18px;font-weight:700;color:#33475b}

        /* Products table */
        .products-table{width:100%;border-collapse:collapse;margin-bottom:0}
        .products-table thead th{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:#33475b;padding:10px 12px;text-align:left;border-bottom:2px solid #33475b}
        .products-table thead th:first-child{padding-left:16px}
        .products-table thead th.qty{text-align:center;width:100px}
        .products-table thead th.price{text-align:right;width:120px;padding-right:16px}
        .products-table tbody td{padding:12px 12px;border-bottom:1px solid #eaf0f6;font-size:14px;color:#33475b}
        .products-table tbody td:first-child{padding-left:16px}
        .products-table tbody td.qty{text-align:center;color:#516f90}
        .products-table tbody td.price{text-align:right;padding-right:16px}

        /* Summary */
        .summary-row{border-bottom:1px solid #eaf0f6}
        .summary-row td{padding:10px 12px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:#33475b;border-bottom:1px solid #eaf0f6}
        .subtotal-row td{padding:10px 12px;font-size:14px;color:#33475b;border-bottom:none}
        .subtotal-row td.price{font-weight:400}

        /* Grand total box */
        .grand-total{display:flex;justify-content:flex-end;margin-top:12px;margin-bottom:32px}
        .grand-total-box{border:1px solid #cbd6e2;border-collapse:collapse;display:flex}
        .grand-total-box .gt-label{padding:10px 24px;font-size:14px;font-weight:600;color:#33475b;border-right:1px solid #cbd6e2;display:flex;align-items:center}
        .grand-total-box .gt-amount{padding:10px 24px;font-size:16px;font-weight:700;color:#33475b;display:flex;align-items:center}

        /* Comments box */
        .section-box{border:1px solid #cbd6e2;border-radius:0;margin-bottom:16px;padding:16px 20px}
        .section-box-label{font-size:13px;font-weight:700;color:#33475b;margin-bottom:8px}
        .section-box-content{font-size:14px;color:#516f90;line-height:1.6}

        /* Editable textarea styled as document text */
        .editable-area{width:100%;font-size:14px;font-family:inherit;color:#33475b;line-height:1.6;padding:8px 10px;border:1.5px dashed #b8d4f0;border-radius:3px;background:#f7faff;resize:vertical;min-height:48px;transition:all 0.15s}
        .editable-area:hover{border-color:#7fb3e0}
        .editable-area:focus{outline:none;border-color:#4C76B8;background:#fff;border-style:solid;box-shadow:0 0 0 2px rgba(76,118,184,0.12)}
        .editable-area::placeholder{color:#b0c4de}

        /* Editable input inline */
        .editable-inline{font-size:13px;font-family:inherit;color:#33475b;padding:3px 8px;border:1.5px dashed #b8d4f0;border-radius:3px;background:#f7faff;width:100%;transition:all 0.15s}
        .editable-inline:hover{border-color:#7fb3e0}
        .editable-inline:focus{outline:none;border-color:#4C76B8;background:#fff;border-style:solid;box-shadow:0 0 0 2px rgba(76,118,184,0.12)}
        .editable-inline::placeholder{color:#b0c4de}

        /* Finalize button */
        .finalize-btn{display:inline-block;padding:12px 32px;background:#4C76B8;color:#fff;border:none;border-radius:3px;font-size:14px;font-weight:600;font-family:inherit;cursor:pointer;transition:background 0.15s;margin-top:8px}
        .finalize-btn:hover:not(:disabled){background:#3d6098}
        .finalize-btn:disabled{opacity:0.5;cursor:not-allowed}

        /* Editable legend */
        .editable-legend{display:flex;align-items:center;gap:8px;font-size:11px;color:#99acc2;margin-bottom:24px;padding:8px 12px;background:#f7faff;border:1px dashed #b8d4f0;border-radius:3px}
        .legend-swatch{width:16px;height:12px;border:1.5px dashed #b8d4f0;background:#f7faff;border-radius:2px;flex-shrink:0}

        /* States */
        .loading-view{text-align:center;padding:120px 20px}
        .spinner{width:32px;height:32px;border:3px solid #eaf0f6;border-top-color:#4C76B8;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-view p{color:#7c98b6;font-size:14px}

        .error-view{text-align:center;padding:120px 20px;display:none}
        .error-view h2{font-size:20px;font-weight:700;color:#33475b;margin-bottom:10px}
        .error-view p{font-size:14px;color:#7c98b6}

        .success-view{text-align:center;padding:80px 20px;display:none}
        .success-icon{width:56px;height:56px;margin:0 auto 20px;background:#d4edda;border-radius:50%;display:flex;align-items:center;justify-content:center}
        .success-icon svg{width:28px;height:28px;color:#155724}
        .success-view h2{font-size:20px;font-weight:700;color:#33475b;margin-bottom:10px}
        .success-view p{font-size:14px;color:#7c98b6;line-height:1.6}
        .view-quote-link{display:inline-block;margin-top:20px;padding:12px 32px;background:#4C76B8;color:#fff;text-decoration:none;border-radius:3px;font-size:14px;font-weight:600;transition:background 0.15s}
        .view-quote-link:hover{background:#3d6098}

        @media(max-width:600px){
            .quote-page{padding:24px 16px 40px}
            .info-row{flex-direction:column;gap:20px}
            .info-right{text-align:left}
            .grand-total{justify-content:stretch}
            .grand-total-box{width:100%}
            .grand-total-box .gt-label,.grand-total-box .gt-amount{flex:1;justify-content:center}
            .po-input{width:140px}
        }
    </style>
</head>
<body>
    <div class="quote-page">
        <!-- Loading -->
        <div class="loading-view" id="loadingView">
            <div class="spinner"></div>
            <p>Loading your quote...</p>
        </div>

        <!-- Error -->
        <div class="error-view" id="errorView">
            <h2>Unable to Load Quote</h2>
            <p id="errorMessage">This link may be invalid or expired.</p>
        </div>

        <!-- Main quote document -->
        <div id="mainView" style="display:none">

            <!-- Company name -->
            <div class="company-header">Show-Off</div>

            <!-- Quote title (editable) -->
            <div class="quote-title">
                <input type="text" class="editable-title" id="quoteTitle" value="">
                <div class="edit-hint">Click to edit title</div>
            </div>

            <!-- Two-column info -->
            <div class="info-row">
                <div class="info-left">
                    <div class="contact-name" id="contactName"></div>
                    <div class="contact-detail" id="contactEmail"></div>
                    <div class="contact-detail" id="contactPhone"></div>

                    <div class="ref-line" id="refLine"></div>
                    <div class="ref-line" id="createdDate"></div>
                    <div class="ref-line" id="expiresDate"></div>

                    <!-- PO Number (editable) -->
                    <div class="po-line">
                        <label>PO Number:</label>
                        <input type="text" class="po-input" id="poNumber" placeholder="Enter PO #">
                    </div>
                </div>
                <div class="info-right">
                    <div class="company-right">Show-Off</div>
                    <div class="prepared-by" style="margin-top:24px"><strong>Prepared by: Scott Sozmen</strong></div>
                    <div class="contact-detail">scott@showoffinc.com</div>
                </div>
            </div>

            <!-- Editable fields legend -->
            <div class="editable-legend">
                <span class="legend-swatch"></span>
                Fields with a dashed border can be edited. Click to type.
            </div>

            <!-- Total header -->
            <div class="total-header">
                <span class="t-label">Total</span>
                <span class="t-amount" id="headerTotal">$0.00</span>
            </div>

            <!-- Products table -->
            <table class="products-table">
                <thead>
                    <tr>
                        <th>Products &amp; Services</th>
                        <th class="qty">Quantity</th>
                        <th class="price">Price</th>
                    </tr>
                </thead>
                <tbody id="itemsBody"></tbody>
                <tbody>
                    <tr class="summary-row"><td colspan="3"><strong>Summary</strong></td></tr>
                    <tr class="subtotal-row">
                        <td colspan="2">One-time subtotal</td>
                        <td class="price" id="subtotalAmount">$0.00</td>
                    </tr>
                </tbody>
            </table>

            <!-- Grand total -->
            <div class="grand-total">
                <div class="grand-total-box">
                    <div class="gt-label">Total</div>
                    <div class="gt-amount" id="grandTotal">$0.00</div>
                </div>
            </div>

            <!-- Addressee / Attention (editable) -->
            <div class="section-box">
                <div class="section-box-label">Attention</div>
                <input type="text" class="editable-inline" id="addressee" placeholder="e.g. Jane Smith, Procurement Dept">
            </div>

            <!-- Comments (editable) -->
            <div class="section-box">
                <div class="section-box-label">Comments</div>
                <textarea class="editable-area" id="quoteNotes" placeholder="Any special terms or notes..."></textarea>
            </div>

            <!-- Purchase terms (read-only display) -->
            <div class="section-box">
                <div class="section-box-label">Purchase terms</div>
                <div class="section-box-content" id="purchaseTerms"></div>
            </div>

            <!-- Finalize -->
            <button class="finalize-btn" id="finalizeBtn" onclick="handleFinalize()">Finalize Quote</button>
        </div>

        <!-- Success -->
        <div class="success-view" id="successView">
            <div class="success-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>
            </div>
            <h2>Quote Finalized</h2>
            <p id="successMessage">Your formal quote has been created and sent to your email.</p>
            <a class="view-quote-link" id="quoteLinkBtn" href="#" target="_blank" style="display:none">View Your Formal Quote</a>
        </div>
    </div>

    <script>
        var urlParams = new URLSearchParams(window.location.search);
        var dealId = urlParams.get('dealId');
        var token = urlParams.get('token');
        var dealData = null;

        if (!dealId || !token) {
            showError('Invalid link. Please use the link from your email.');
        } else {
            loadData();
        }

        async function loadData() {
            try {
                var res = await fetch('/api/po-quote-review?dealId=' + dealId + '&token=' + token);
                if (res.status === 403) {
                    showError('This link is invalid or has expired. Please contact Show Off Inc. for a new link.');
                    return;
                }
                if (!res.ok) throw new Error('Failed to load quote');
                dealData = await res.json();

                // Quote title
                document.getElementById('quoteTitle').value = dealData.poFields.title || dealData.dealName || '';

                // Contact info
                if (dealData.primaryContact) {
                    document.getElementById('contactName').textContent = dealData.primaryContact.name || '';
                    document.getElementById('contactEmail').textContent = dealData.primaryContact.email || '';
                }

                // Reference & dates
                var now = new Date();
                var refId = now.toISOString().replace(/[-T:]/g,'').substring(0,8) + '-' + dealData.dealId;
                document.getElementById('refLine').textContent = 'Reference: ' + refId;
                document.getElementById('createdDate').textContent = 'Quote created: ' + formatDateLong(now);
                document.getElementById('expiresDate').textContent = 'Quote expires: ' + formatDateLong(new Date(dealData.expirationDate));

                // Line items
                var tbody = document.getElementById('itemsBody');
                dealData.lineItems.forEach(function(item) {
                    var lineTotal = item.quantity * item.price;
                    var tr = document.createElement('tr');
                    tr.innerHTML =
                        '<td>' + esc(item.name) + '</td>' +
                        '<td class="qty">' + item.quantity + '</td>' +
                        '<td class="price">$' + formatNum(lineTotal) + '</td>';
                    tbody.appendChild(tr);
                });

                // Totals
                var total = dealData.total || 0;
                document.getElementById('headerTotal').textContent = '$' + formatNum(total);
                document.getElementById('subtotalAmount').textContent = '$' + formatNum(total);
                document.getElementById('grandTotal').textContent = '$' + formatNum(total);

                // Pre-fill editable fields
                document.getElementById('addressee').value = dealData.poFields.addressee || '';
                document.getElementById('quoteNotes').value = dealData.poFields.notes || '';

                // Hide loading, show quote
                document.getElementById('loadingView').style.display = 'none';
                document.getElementById('mainView').style.display = 'block';
            } catch (err) {
                showError('Unable to load your quote. Please try again or contact Show Off Inc.');
            }
        }

        function showError(msg) {
            document.getElementById('loadingView').style.display = 'none';
            document.getElementById('errorMessage').textContent = msg;
            document.getElementById('errorView').style.display = 'block';
        }

        function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

        function formatNum(n) {
            return Number(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatDateLong(d) {
            var months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            return months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
        }

        async function handleFinalize() {
            var btn = document.getElementById('finalizeBtn');
            btn.disabled = true;
            btn.textContent = 'Finalizing...';

            var payload = {
                dealId: dealId,
                token: token,
                quoteTitle: document.getElementById('quoteTitle').value || dealData.dealName,
                addressee: document.getElementById('addressee').value,
                poNumber: document.getElementById('poNumber').value,
                quoteNotes: document.getElementById('quoteNotes').value,
                contactEmail: dealData.primaryContact ? dealData.primaryContact.email : null,
                contactName: dealData.primaryContact ? dealData.primaryContact.name : null,
                contactId: dealData.primaryContact ? dealData.primaryContact.id : null
            };

            try {
                var res = await fetch('https://showoffinc.app.n8n.cloud/webhook/finalize-po-quote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                var data = await res.json();

                if (res.ok && data.success) {
                    document.getElementById('mainView').style.display = 'none';

                    if (data.quoteLink) {
                        var linkBtn = document.getElementById('quoteLinkBtn');
                        linkBtn.href = data.quoteLink;
                        linkBtn.style.display = 'inline-block';
                    }

                    var msg = 'Your formal quote has been created';
                    if (dealData.primaryContact && dealData.primaryContact.email) {
                        msg += ' and sent to ' + dealData.primaryContact.email;
                    }
                    msg += '.';
                    document.getElementById('successMessage').textContent = msg;
                    document.getElementById('successView').style.display = 'block';
                } else {
                    throw new Error(data.error || 'Server error');
                }
            } catch (err) {
                alert('Error finalizing quote: ' + err.message + '. Please try again.');
                btn.disabled = false;
                btn.textContent = 'Finalize Quote';
            }
        }
    </script>
</body>
</html>
