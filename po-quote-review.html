<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quote Review | Show Off Inc.</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Inter',-apple-system,sans-serif;background:#faf9f7;min-height:100vh;padding:20px;color:#2a2220;font-size:13px;line-height:1.5}

        .quote-doc{max-width:680px;margin:0 auto;background:rgba(255,255,255,0.82);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.3);box-shadow:0 8px 32px rgba(0,0,0,0.08);border-radius:2px;padding:48px 40px 36px}

        /* Logo + Header */
        .doc-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:32px;padding-bottom:20px;border-bottom:1.5px solid rgba(42,34,32,0.1)}
        .brand{display:flex;flex-direction:column}
        .brand-name{font-family:'Cormorant Garamond',Georgia,serif;font-size:22px;font-weight:600;letter-spacing:0.06em;color:#2a2220}
        .brand-sub{font-size:9px;letter-spacing:0.2em;text-transform:uppercase;color:#999;margin-top:2px}
        .doc-type{text-align:right}
        .doc-type h1{font-family:'Cormorant Garamond',Georgia,serif;font-size:26px;font-weight:500;letter-spacing:0.04em;color:#2a2220}
        .doc-type .deal-num{font-size:10px;letter-spacing:0.12em;text-transform:uppercase;color:#999;margin-top:4px}

        /* Meta row */
        .meta-row{display:flex;justify-content:space-between;margin-bottom:28px;padding:14px 18px;background:linear-gradient(145deg,rgba(255,252,248,0.9),rgba(248,245,240,0.7));border:1px solid rgba(200,180,170,0.15);border-radius:2px}
        .meta-item{display:flex;flex-direction:column}
        .meta-label{font-size:8px;letter-spacing:0.25em;text-transform:uppercase;color:#999;margin-bottom:3px}
        .meta-value{font-size:12px;color:#2a2220}

        /* Line items table */
        .section-label{font-size:8px;letter-spacing:0.25em;text-transform:uppercase;color:#999;margin-bottom:10px;margin-top:0}
        .items-table{width:100%;border-collapse:collapse;margin-bottom:0}
        .items-table thead th{font-size:8px;letter-spacing:0.2em;text-transform:uppercase;color:#999;padding:0 12px 10px;text-align:left;font-weight:400;border-bottom:1px solid rgba(200,180,170,0.2)}
        .items-table thead th:nth-child(2){text-align:center;width:70px}
        .items-table thead th:nth-child(3){text-align:right;width:100px}
        .items-table thead th:nth-child(4){text-align:right;width:100px}
        .items-table tbody td{padding:14px 12px;border-bottom:1px solid rgba(200,180,170,0.1);font-size:13px}
        .items-table tbody td:nth-child(2){text-align:center;color:#666}
        .items-table tbody td:nth-child(3){text-align:right;color:#666}
        .items-table tbody td:nth-child(4){text-align:right;font-weight:500}
        .items-table tbody tr:last-child td{border-bottom:none}

        /* Totals */
        .totals-section{margin-top:12px;padding:16px 18px;background:linear-gradient(145deg,rgba(255,255,255,0.92),rgba(255,252,250,0.88));border:1.5px solid rgba(42,34,32,0.2);border-radius:2px}
        .total-row{display:flex;justify-content:space-between;padding:4px 0}
        .total-row .label{font-size:11px;color:#888}
        .total-row .amount{font-size:14px;color:#2a2220}
        .total-row.grand{padding-top:10px;margin-top:8px;border-top:1px solid rgba(200,180,170,0.2)}
        .total-row.grand .label{font-size:13px;font-weight:500;color:#2a2220}
        .total-row.grand .amount{font-family:'Cormorant Garamond',Georgia,serif;font-size:22px;font-weight:600}

        /* Editable fields section */
        .details-section{margin-top:28px;padding:24px 20px;background:linear-gradient(145deg,rgba(255,248,230,0.45),rgba(255,252,240,0.35));border:1.5px solid rgba(200,170,100,0.25);border-radius:2px}
        .details-section h3{font-family:'Cormorant Garamond',Georgia,serif;font-size:16px;font-weight:500;margin-bottom:4px}
        .details-section p{font-size:11px;color:#8b7355;margin-bottom:16px}
        .field-group{margin-top:16px}
        .field-group:first-of-type{margin-top:0}
        .field-label{display:block;font-family:'Cormorant Garamond',Georgia,serif;font-size:14px;font-weight:500;color:#2a2220;margin-bottom:6px}
        .field-hint{font-size:10px;color:#aaa;margin-top:4px;font-style:italic}
        input[type=text],textarea{width:100%;padding:10px 12px;font-size:13px;font-family:'Inter',sans-serif;border:1px solid rgba(200,180,170,0.25);border-radius:2px;background:rgba(255,255,255,0.6);color:#2a2220;transition:border-color 0.2s}
        input:focus,textarea:focus{outline:none;border-color:rgba(200,170,155,0.6);box-shadow:0 0 0 3px rgba(200,170,155,0.1);background:rgba(255,255,255,0.95)}
        textarea{resize:vertical;min-height:80px}

        /* Contact info */
        .contact-notice{margin-top:20px;padding:12px 16px;background:rgba(42,34,32,0.03);border:1px solid rgba(42,34,32,0.06);border-radius:2px;font-size:12px;color:#666;text-align:center}
        .contact-notice strong{color:#2a2220}

        /* Action button */
        .action-btn{width:100%;padding:20px;font-size:16px;font-weight:500;font-family:'Cormorant Garamond',Georgia,serif;letter-spacing:0.04em;background:#2a2220;color:#fff;border:2px solid #2a2220;border-radius:2px;cursor:pointer;transition:all 0.2s;margin-top:24px}
        .action-btn:hover{background:#1a1510}
        .action-btn:disabled{background:#b0a5a0;border-color:#b0a5a0;cursor:not-allowed}

        /* States */
        .loading{display:none;text-align:center;padding:60px 20px}
        .loading.active{display:block}
        .spinner{width:32px;height:32px;border:2px solid rgba(42,34,32,0.1);border-top-color:#2a2220;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .error-view{display:none;text-align:center;padding:60px 20px}
        .error-view.active{display:block}
        .error-title{font-family:'Cormorant Garamond',Georgia,serif;font-size:22px;margin-bottom:12px;color:#c62828}
        .error-message{font-size:13px;color:#666}
        .success-view{display:none;text-align:center;padding:60px 20px}
        .success-view.active{display:block}
        .success-icon{width:64px;height:64px;margin:0 auto 20px;color:#2e7d32}
        .success-title{font-family:'Cormorant Garamond',Georgia,serif;font-size:22px;margin-bottom:12px}
        .success-message{font-size:13px;color:#666;line-height:1.6}
        .quote-link{display:inline-block;margin-top:16px;padding:12px 24px;background:#2a2220;color:#fff;text-decoration:none;border-radius:2px;font-family:'Cormorant Garamond',Georgia,serif;font-size:15px;letter-spacing:0.04em;transition:background 0.2s}
        .quote-link:hover{background:#1a1510}

        .footer{text-align:center;padding-top:24px;font-size:10px;color:#aaa;letter-spacing:0.08em}

        @media(max-width:600px){
            .quote-doc{padding:28px 20px 24px}
            .doc-header{flex-direction:column;gap:12px}
            .doc-type{text-align:left}
            .meta-row{flex-direction:column;gap:10px}
            .items-table thead th:first-child,.items-table tbody td:first-child{max-width:140px}
        }
    </style>
</head>
<body>
    <div class="quote-doc">
        <!-- Loading -->
        <div class="loading active" id="loadingView">
            <div class="spinner"></div>
            <p>Loading your quote...</p>
        </div>

        <!-- Error -->
        <div class="error-view" id="errorView">
            <h2 class="error-title">Unable to Load Quote</h2>
            <p class="error-message" id="errorMessage">This link may be invalid or expired.</p>
        </div>

        <!-- Main content -->
        <div id="mainView" style="display:none">
            <!-- Header -->
            <div class="doc-header">
                <div class="brand">
                    <div class="brand-name">Show Off Inc.</div>
                    <div class="brand-sub">Custom Performance Wear</div>
                </div>
                <div class="doc-type">
                    <h1>Quote</h1>
                    <div class="deal-num" id="dealNum"></div>
                </div>
            </div>

            <!-- Meta -->
            <div class="meta-row">
                <div class="meta-item">
                    <span class="meta-label">Prepared For</span>
                    <span class="meta-value" id="metaContact">—</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Date</span>
                    <span class="meta-value" id="metaDate"></span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Valid Until</span>
                    <span class="meta-value" id="metaExpires"></span>
                </div>
            </div>

            <!-- Line items -->
            <div class="section-label">Line Items</div>
            <table class="items-table">
                <thead>
                    <tr><th>Item</th><th>Qty</th><th>Unit Price</th><th>Total</th></tr>
                </thead>
                <tbody id="itemsBody"></tbody>
            </table>

            <!-- Totals -->
            <div class="totals-section">
                <div class="total-row"><span class="label">Subtotal</span><span class="amount" id="subtotal">$0.00</span></div>
                <div class="total-row grand"><span class="label">Total</span><span class="amount" id="totalAmount">$0.00</span></div>
            </div>

            <!-- Editable quote details -->
            <div class="details-section">
                <h3>Quote Details</h3>
                <p>Please review and edit these fields before finalizing</p>
                <div class="field-group">
                    <label class="field-label" for="quoteTitle">Quote Title</label>
                    <input type="text" id="quoteTitle" placeholder="e.g. Jefferson County ISD — Twirling Team">
                </div>
                <div class="field-group">
                    <label class="field-label" for="addressee">Attention</label>
                    <input type="text" id="addressee" placeholder="e.g. Jane Smith, Procurement Dept">
                    <div class="field-hint">Who this quote is addressed to</div>
                </div>
                <div class="field-group">
                    <label class="field-label" for="poNumber">PO Number</label>
                    <input type="text" id="poNumber" placeholder="Enter your purchase order number">
                    <div class="field-hint">Your organization's PO number for this order</div>
                </div>
                <div class="field-group">
                    <label class="field-label" for="quoteNotes">Special Notes</label>
                    <textarea id="quoteNotes" placeholder="Any special terms or notes for this quote..."></textarea>
                </div>
            </div>

            <!-- Contact notice -->
            <div class="contact-notice" id="contactNotice" style="display:none">
                The finalized quote will be sent to <strong id="sentToEmail"></strong>
            </div>

            <button class="action-btn" id="finalizeBtn" onclick="handleFinalize()">Finalize Quote</button>
        </div>

        <!-- Success -->
        <div class="success-view" id="successView">
            <div class="success-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="64" height="64">
                    <path d="M5 13l4 4L19 7"/>
                </svg>
            </div>
            <h2 class="success-title">Quote Finalized</h2>
            <p class="success-message" id="successMessage">Your formal quote has been created. A copy has been sent to your email.</p>
            <a class="quote-link" id="quoteLinkBtn" href="#" target="_blank" style="display:none">View Your Formal Quote</a>
        </div>

        <div class="footer">Show Off Inc.</div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const dealId = urlParams.get('dealId');
        const token = urlParams.get('token');
        let dealData = null;

        if (!dealId || !token) {
            showError('Invalid link. Please use the link from your email.');
        } else {
            loadData();
        }

        async function loadData() {
            try {
                const res = await fetch(`/api/po-quote-review?dealId=${dealId}&token=${token}`);
                if (res.status === 403) {
                    showError('This link is invalid or has expired. Please contact Show Off Inc. for a new link.');
                    return;
                }
                if (!res.ok) throw new Error('Failed to load quote');
                dealData = await res.json();

                // Header
                const dealNum = dealData.dealName.split(' ')[0];
                document.getElementById('dealNum').textContent = `Order #${dealNum}`;

                // Meta
                if (dealData.primaryContact) {
                    document.getElementById('metaContact').textContent = dealData.primaryContact.name || dealData.primaryContact.email;
                }
                document.getElementById('metaDate').textContent = formatDate(new Date());
                document.getElementById('metaExpires').textContent = formatDate(new Date(dealData.expirationDate));

                // Line items
                const tbody = document.getElementById('itemsBody');
                dealData.lineItems.forEach(function(item) {
                    const lineTotal = item.quantity * item.price;
                    const tr = document.createElement('tr');
                    tr.innerHTML =
                        '<td>' + esc(item.name) + '</td>' +
                        '<td>' + item.quantity + '</td>' +
                        '<td>$' + item.price.toFixed(2) + '</td>' +
                        '<td>$' + lineTotal.toFixed(2) + '</td>';
                    tbody.appendChild(tr);
                });

                // Totals
                document.getElementById('subtotal').textContent = '$' + dealData.total.toFixed(2);
                document.getElementById('totalAmount').textContent = '$' + dealData.total.toFixed(2);

                // Pre-fill editable fields from admin draft
                document.getElementById('quoteTitle').value = dealData.poFields.title || dealData.dealName;
                document.getElementById('addressee').value = dealData.poFields.addressee || '';
                document.getElementById('quoteNotes').value = dealData.poFields.notes || '';

                // Contact notice
                if (dealData.primaryContact && dealData.primaryContact.email) {
                    document.getElementById('sentToEmail').textContent = dealData.primaryContact.email;
                    document.getElementById('contactNotice').style.display = 'block';
                }

                document.getElementById('loadingView').classList.remove('active');
                document.getElementById('mainView').style.display = 'block';
            } catch (err) {
                showError('Unable to load your quote. Please try again or contact Show Off Inc.');
            }
        }

        function showError(msg) {
            document.getElementById('loadingView').classList.remove('active');
            document.getElementById('errorMessage').textContent = msg;
            document.getElementById('errorView').classList.add('active');
        }

        function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

        function formatDate(d) {
            var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            return months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
        }

        async function handleFinalize() {
            var btn = document.getElementById('finalizeBtn');
            btn.disabled = true;
            btn.textContent = 'Finalizing...';

            var payload = {
                dealId: dealId,
                token: token,
                quoteTitle: document.getElementById('quoteTitle').value || dealData.dealName,
                addressee: document.getElementById('addressee').value,
                poNumber: document.getElementById('poNumber').value,
                quoteNotes: document.getElementById('quoteNotes').value,
                contactEmail: dealData.primaryContact ? dealData.primaryContact.email : null,
                contactName: dealData.primaryContact ? dealData.primaryContact.name : null,
                contactId: dealData.primaryContact ? dealData.primaryContact.id : null
            };

            try {
                var res = await fetch('https://showoffinc.app.n8n.cloud/webhook/finalize-po-quote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                var data = await res.json();

                if (res.ok && data.success) {
                    document.getElementById('mainView').style.display = 'none';

                    if (data.quoteLink) {
                        var linkBtn = document.getElementById('quoteLinkBtn');
                        linkBtn.href = data.quoteLink;
                        linkBtn.style.display = 'inline-block';
                    }

                    var msg = 'Your formal quote has been created';
                    if (dealData.primaryContact && dealData.primaryContact.email) {
                        msg += ' and sent to ' + dealData.primaryContact.email;
                    }
                    msg += '.';
                    document.getElementById('successMessage').textContent = msg;
                    document.getElementById('successView').classList.add('active');
                } else {
                    throw new Error(data.error || 'Server error');
                }
            } catch (err) {
                alert('Error finalizing quote: ' + err.message + '. Please try again.');
                btn.disabled = false;
                btn.textContent = 'Finalize Quote';
            }
        }
    </script>
</body>
</html>
