<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quote Review | Show Off Inc.</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Inter',-apple-system,'Helvetica Neue',sans-serif;background:#eaf0f6;min-height:100vh;padding:0;color:#33475b;font-size:14px;line-height:1.6;-webkit-font-smoothing:antialiased}

        .page-wrap{max-width:780px;margin:0 auto;padding:24px 16px 60px}
        .quote-card{background:#fff;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.1);overflow:hidden}

        /* ── Dark header banner (matches "Basic - ShowOff" template) ── */
        .header-banner{background:#2d3e50;color:#fff;padding:28px 36px 24px}
        .brand-text{font-size:20px;font-weight:700;color:#fff;margin-bottom:16px;letter-spacing:-0.01em}

        /* Quote title — editable */
        .quote-title-wrap{margin-bottom:20px}
        .quote-title-input{width:100%;font-size:22px;font-weight:700;color:#fff;background:transparent;border:1.5px dashed rgba(255,255,255,0.3);border-radius:4px;padding:8px 12px;font-family:inherit;transition:all 0.15s}
        .quote-title-input:hover{border-color:rgba(255,255,255,0.5);background:rgba(255,255,255,0.06)}
        .quote-title-input:focus{outline:none;border-color:rgba(255,255,255,0.7);background:rgba(255,255,255,0.1);border-style:solid}
        .quote-title-input::placeholder{color:rgba(255,255,255,0.4)}

        /* Two-column info inside banner */
        .banner-info{display:flex;justify-content:space-between;gap:16px}
        .banner-left{flex:1;min-width:0}
        .banner-right{flex:0 0 220px;text-align:right}

        /* Editable fields inside dark banner */
        .dark-editable{width:100%;font-size:13px;color:#fff;background:transparent;border:1.5px dashed rgba(255,255,255,0.25);border-radius:3px;padding:5px 10px;font-family:inherit;transition:all 0.15s}
        .dark-editable:hover{border-color:rgba(255,255,255,0.45);background:rgba(255,255,255,0.06)}
        .dark-editable:focus{outline:none;border-color:rgba(255,255,255,0.7);background:rgba(255,255,255,0.1);border-style:solid}
        .dark-editable::placeholder{color:rgba(255,255,255,0.35)}
        textarea.dark-editable{resize:vertical;min-height:44px}

        .dark-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:rgba(255,255,255,0.5);margin-bottom:3px;margin-top:10px}
        .dark-label:first-child{margin-top:0}

        .banner-static{font-size:13px;color:rgba(255,255,255,0.85);line-height:1.5}
        .banner-static strong{color:#fff;font-weight:600}

        /* Address row inside banner */
        .address-row{display:flex;gap:8px;margin-top:2px}
        .address-row .dark-editable{width:auto}
        .addr-city{flex:1;max-width:180px}
        .addr-state{flex:0 0 60px}
        .addr-zip{flex:0 0 80px}

        .dark-editable-sm{width:auto;font-size:13px;color:#fff;background:transparent;border:1.5px dashed rgba(255,255,255,0.25);border-radius:3px;padding:4px 8px;font-family:inherit;transition:all 0.15s}
        .dark-editable-sm:hover{border-color:rgba(255,255,255,0.45);background:rgba(255,255,255,0.06)}
        .dark-editable-sm:focus{outline:none;border-color:rgba(255,255,255,0.7);background:rgba(255,255,255,0.1);border-style:solid}
        .dark-editable-sm::placeholder{color:rgba(255,255,255,0.35)}

        /* ── White content area ── */
        .content-area{padding:0 36px 32px}

        /* Editable legend */
        .edit-legend{display:flex;align-items:center;gap:8px;font-size:11px;color:#7c98b6;padding:16px 0 16px;border-bottom:1px solid #eaf0f6;margin-bottom:0}
        .legend-swatch{width:20px;height:14px;border:1.5px dashed #b8d4f0;background:#f7faff;border-radius:2px;flex-shrink:0}

        /* Comments section */
        .comments-section{padding:20px 0;border-bottom:1px solid #eaf0f6}
        .comments-label{font-size:13px;font-weight:700;color:#33475b;margin-bottom:8px}
        .light-editable{width:100%;font-size:14px;font-family:inherit;color:#33475b;line-height:1.6;padding:10px 12px;border:1.5px dashed #b8d4f0;border-radius:4px;background:#f7faff;resize:vertical;min-height:60px;transition:all 0.15s}
        .light-editable:hover{border-color:#7fb3e0}
        .light-editable:focus{outline:none;border-color:#4C76B8;background:#fff;border-style:solid;box-shadow:0 0 0 2px rgba(76,118,184,0.12)}
        .light-editable::placeholder{color:#b0c4de}

        /* Products table */
        .products-heading{font-size:14px;font-weight:700;color:#33475b;padding:20px 0 12px}
        .products-table{width:100%;border-collapse:collapse}
        .products-table thead th{font-size:12px;font-weight:700;color:#33475b;padding:8px 0;text-align:left;border-bottom:2px solid #33475b}
        .products-table thead th.qty{text-align:center;width:90px}
        .products-table thead th.price{text-align:right;width:110px}
        .products-table thead th.total{text-align:right;width:110px}
        .products-table tbody td{padding:14px 0;border-bottom:1px solid #eaf0f6;font-size:14px;color:#33475b}
        .products-table tbody td.qty{text-align:center;color:#516f90}
        .products-table tbody td.price{text-align:right;color:#516f90}
        .products-table tbody td.total{text-align:right;font-weight:500}
        .products-table tbody tr:last-child td{border-bottom:1px solid #eaf0f6}

        /* Summary + Total */
        .subtotal-row{display:flex;justify-content:flex-end;padding:10px 0;font-size:14px;color:#516f90}
        .subtotal-row span:last-child{min-width:110px;text-align:right}
        .total-row{display:flex;justify-content:flex-end;padding:10px 0;font-size:16px;font-weight:700;color:#33475b;border-top:none}
        .total-row span:last-child{min-width:110px;text-align:right}

        /* Purchase terms */
        .terms-section{padding:20px 0;border-top:1px solid #eaf0f6}
        .terms-label{font-size:14px;font-weight:700;color:#33475b;margin-bottom:8px}

        /* PO Number in white area */
        .po-section{padding:16px 0;border-top:1px solid #eaf0f6}
        .po-label{font-size:12px;font-weight:600;color:#33475b;margin-bottom:6px}
        .light-input{font-size:14px;font-family:inherit;color:#33475b;padding:8px 12px;border:1.5px dashed #b8d4f0;border-radius:4px;background:#f7faff;width:260px;transition:all 0.15s}
        .light-input:hover{border-color:#7fb3e0}
        .light-input:focus{outline:none;border-color:#4C76B8;background:#fff;border-style:solid;box-shadow:0 0 0 2px rgba(76,118,184,0.12)}
        .light-input::placeholder{color:#b0c4de}

        /* Contact me footer */
        .contact-footer{padding:20px 0;border-top:1px solid #eaf0f6;font-size:13px;color:#516f90}
        .contact-footer strong{color:#33475b;display:block;margin-bottom:4px}

        /* Finalize button */
        .finalize-section{padding:24px 0 0;border-top:1px solid #eaf0f6;display:flex;align-items:center;gap:16px}
        .finalize-btn{padding:12px 36px;background:#4C76B8;color:#fff;border:none;border-radius:4px;font-size:14px;font-weight:600;font-family:inherit;cursor:pointer;transition:background 0.15s}
        .finalize-btn:hover:not(:disabled){background:#3d6098}
        .finalize-btn:disabled{opacity:0.5;cursor:not-allowed}
        .finalize-note{font-size:12px;color:#7c98b6}

        /* ── States ── */
        .loading-view{text-align:center;padding:100px 20px}
        .spinner{width:32px;height:32px;border:3px solid #eaf0f6;border-top-color:#4C76B8;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-view p{color:#7c98b6;font-size:14px}

        .error-view{text-align:center;padding:100px 20px;display:none}
        .error-view h2{font-size:18px;font-weight:700;color:#33475b;margin-bottom:8px}
        .error-view p{font-size:14px;color:#7c98b6}

        .success-view{text-align:center;padding:80px 36px;display:none}
        .success-icon{width:56px;height:56px;margin:0 auto 20px;background:#d4edda;border-radius:50%;display:flex;align-items:center;justify-content:center}
        .success-icon svg{width:28px;height:28px;color:#155724}
        .success-view h2{font-size:18px;font-weight:700;color:#33475b;margin-bottom:8px}
        .success-view p{font-size:14px;color:#7c98b6;line-height:1.6}
        .view-quote-link{display:inline-block;margin-top:20px;padding:12px 32px;background:#4C76B8;color:#fff;text-decoration:none;border-radius:4px;font-size:14px;font-weight:600;transition:background 0.15s}
        .view-quote-link:hover{background:#3d6098}

        /* ── PO Upload section ── */
        .po-upload-section{text-align:left;margin-top:32px;border-top:1px solid #eaf0f6;padding-top:28px}
        .upload-dropzone{border:2px dashed #cbd6e2;border-radius:8px;padding:32px 20px;text-align:center;cursor:pointer;transition:all 0.15s;color:#7c98b6;font-size:14px}
        .upload-dropzone:hover{border-color:#4C76B8;background:#f7faff}
        .upload-dropzone.dragover{border-color:#4C76B8;background:#eef4ff}
        .upload-dropzone svg{width:36px;height:36px;color:#7c98b6;margin-bottom:8px}
        .po-file-display{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:#f7faff;border:1px solid #eaf0f6;border-radius:4px;margin-top:12px;font-size:13px;color:#33475b}
        .po-file-remove{color:#d9534f;cursor:pointer;font-size:12px;font-weight:600}
        .po-file-remove:hover{text-decoration:underline}
        .upload-btn{display:inline-block;margin-top:16px;padding:10px 28px;background:#4C76B8;color:#fff;border:none;border-radius:4px;font-size:14px;font-weight:600;font-family:inherit;cursor:pointer;transition:background 0.15s}
        .upload-btn:hover:not(:disabled){background:#3d6098}
        .upload-btn:disabled{opacity:0.5;cursor:not-allowed}
        .upload-progress{height:4px;background:#eaf0f6;border-radius:2px;overflow:hidden;margin-top:12px}
        .upload-progress-bar{height:100%;background:#4C76B8;border-radius:2px;width:0;transition:width 0.3s}
        .po-received-badge{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;background:#d4edda;color:#155724;border-radius:4px;font-size:14px;font-weight:600}
        .po-received-badge svg{width:18px;height:18px;flex-shrink:0}

        /* ── Print stylesheet ── */
        @media print{
            body{background:#fff;padding:0;font-size:13px}
            .page-wrap{padding:0;max-width:none}
            .quote-card{box-shadow:none;border:none}
            .header-banner{padding:20px 24px 16px;-webkit-print-color-adjust:exact;print-color-adjust:exact}
            .content-area{padding:0 24px 16px}
            /* Make editable fields look like plain text */
            .quote-title-input,.dark-editable,.dark-editable-sm,.light-editable,.light-input{border:none!important;background:transparent!important;padding:2px 0!important;box-shadow:none!important}
            textarea.dark-editable,textarea.light-editable{min-height:auto!important;resize:none!important}
            /* Hide interactive elements */
            .edit-legend,.finalize-section,.po-section:has(#sendToEmail),.po-section:has(#ccEmails),.contact-footer,.po-upload-section,#requestChangesSection{display:none!important}
            .success-view .view-quote-link,.success-view button,.upload-btn,.upload-dropzone{display:none!important}
            /* Clean up spacing */
            .products-table{page-break-inside:avoid}
            .terms-section{border-top:1px solid #ccc}
            .po-section{border-top:1px solid #ccc}
        }

        @media(max-width:600px){
            .page-wrap{padding:8px 4px 40px}
            .header-banner{padding:20px 20px 18px}
            .content-area{padding:0 20px 24px}
            .banner-info{flex-direction:column;gap:16px}
            .banner-right{text-align:left}
            .address-row{flex-wrap:wrap}
            .light-input{width:100%}
        }
    </style>
</head>
<body>
    <div class="page-wrap">
        <div class="quote-card">
            <!-- Loading -->
            <div class="loading-view" id="loadingView">
                <div class="spinner"></div>
                <p>Loading your quote...</p>
            </div>

            <!-- Error -->
            <div class="error-view" id="errorView">
                <h2>Unable to Load Quote</h2>
                <p id="errorMessage">This link may be invalid or expired.</p>
            </div>

            <!-- ═══ MAIN QUOTE DOCUMENT ═══ -->
            <div id="mainView" style="display:none">

                <!-- ── Dark header banner ── -->
                <div class="header-banner">
                    <div style="display:flex;justify-content:space-between;align-items:baseline">
                        <div class="brand-text">Trimsuits by Show Off Inc.</div>
                        <div id="quoteRef" style="font-size:12px;font-weight:600;color:rgba(255,255,255,0.6);letter-spacing:0.05em"></div>
                    </div>

                    <!-- Quote title (editable) -->
                    <div class="quote-title-wrap">
                        <input type="text" class="quote-title-input" id="quoteTitle" placeholder="Quote title...">
                    </div>

                    <div class="banner-info">
                        <div class="banner-left">
                            <!-- School / Organization name (editable) -->
                            <div class="dark-label">Company / School</div>
                            <input type="text" class="dark-editable" id="schoolName" placeholder="e.g. UGA Majorettes" style="max-width:320px">

                            <!-- Attention line (editable) -->
                            <div class="dark-label">Attention</div>
                            <textarea class="dark-editable" id="attentionLine" rows="2" placeholder="e.g. Att: Ashley Clark, 2025-2026 Uniforms, 250 River Road"></textarea>

                            <!-- Mailing address (editable) -->
                            <div class="dark-label">Mailing Address</div>
                            <div class="address-row">
                                <input type="text" class="dark-editable-sm addr-city" id="addrCity" placeholder="City">
                                <input type="text" class="dark-editable-sm addr-state" id="addrState" placeholder="State">
                                <input type="text" class="dark-editable-sm addr-zip" id="addrZip" placeholder="ZIP">
                            </div>
                            <input type="text" class="dark-editable-sm" id="addrCountry" placeholder="Country" style="margin-top:4px;width:180px" value="United States">
                        </div>

                        <div class="banner-right">
                            <div class="banner-static" id="createdDate"></div>
                            <div class="banner-static" id="expiresDate"></div>
                            <div class="banner-static" style="margin-top:4px">Quote created by: <strong>Support Team</strong></div>
                            <div class="banner-static" style="margin-top:12px">support@showoffinc.com</div>
                        </div>
                    </div>
                </div>

                <!-- ── White content area ── -->
                <div class="content-area">

                    <!-- Editable legend -->
                    <div class="edit-legend">
                        <span class="legend-swatch"></span>
                        Fields with a dashed border are editable — click to type
                    </div>

                    <!-- Comments for PO Issuer -->
                    <div class="comments-section">
                        <div class="comments-label">Comments for PO Issuer</div>
                        <textarea class="light-editable" id="quoteNotes" placeholder="Comments will appear here..."></textarea>
                    </div>

                    <!-- Products & Services -->
                    <div class="products-heading">Products &amp; Services</div>
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>Item &amp; Description</th>
                                <th class="qty">Quantity</th>
                                <th class="price">Unit Price</th>
                                <th class="total">Total</th>
                            </tr>
                        </thead>
                        <tbody id="itemsBody"></tbody>
                    </table>

                    <!-- Subtotal + Total -->
                    <div class="subtotal-row">
                        <span>One-time subtotal</span>
                        <span id="subtotalAmount">$0.00</span>
                    </div>
                    <div class="total-row">
                        <span>Total</span>
                        <span id="grandTotal">$0.00</span>
                    </div>

                    <!-- Purchase terms -->
                    <div class="terms-section">
                        <div class="terms-label">Purchase terms</div>
                        <div style="font-size:14px;color:#516f90" id="purchaseTermsDisplay">Net 30</div>
                    </div>

                    <!-- PO Number -->
                    <div class="po-section">
                        <div class="po-label">PO Number</div>
                        <input type="text" class="light-input" id="poNumber" placeholder="Enter your PO number">
                    </div>

                    <!-- Send quote to (editable email + CC) -->
                    <div class="po-section">
                        <div class="po-label">Send finalized quote to</div>
                        <input type="email" class="light-input" id="sendToEmail" placeholder="email@example.com" style="width:320px">
                        <div style="font-size:11px;color:#99acc2;margin-top:4px">Primary recipient for the finalized quote</div>
                        <div style="margin-top:12px">
                            <div class="po-label">CC (optional)</div>
                            <input type="text" class="light-input" id="ccEmails" placeholder="email1@example.com, email2@example.com" style="width:100%">
                            <div style="font-size:11px;color:#99acc2;margin-top:4px">Additional recipients — separate multiple emails with commas (e.g. AP department, budget approver)</div>
                        </div>
                    </div>

                    <!-- Questions? Contact us -->
                    <div class="contact-footer">
                        <strong>Have questions?</strong>
                        <div>Email us at <a href="mailto:support@showoffinc.com" style="color:#4C76B8;text-decoration:none">support@showoffinc.com</a></div>
                    </div>

                    <!-- Print -->
                    <div class="po-section" style="border-top:1px solid #eaf0f6">
                        <button onclick="window.print()" style="padding:8px 20px;background:#fff;color:#516f90;border:1px solid #cbd6e2;border-radius:4px;font-size:13px;font-weight:500;font-family:inherit;cursor:pointer;transition:all 0.15s">Print Quote</button>
                    </div>

                    <!-- Request Changes -->
                    <div id="requestChangesSection" class="po-section" style="border-top:1px solid #eaf0f6">
                        <button id="requestChangesBtn" onclick="toggleChangeRequest()" style="padding:10px 24px;background:#fff;color:#33475b;border:1px solid #cbd6e2;border-radius:4px;font-size:14px;font-weight:600;font-family:inherit;cursor:pointer;transition:all 0.15s">Request Changes</button>
                        <div id="changeRequestForm" style="display:none;margin-top:12px">
                            <div class="po-label">What needs to change?</div>
                            <textarea class="light-editable" id="changeRequestText" placeholder="Describe what you'd like changed — items, pricing, quantities, etc." style="min-height:80px"></textarea>
                            <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
                                <button id="sendChangeBtn" onclick="sendChangeRequest()" style="padding:8px 20px;background:#4C76B8;color:#fff;border:none;border-radius:4px;font-size:13px;font-weight:600;font-family:inherit;cursor:pointer">Send via Email</button>
                                <button onclick="toggleChangeRequest()" style="padding:8px 16px;background:transparent;color:#7c98b6;border:none;font-size:13px;font-family:inherit;cursor:pointer">Cancel</button>
                            </div>
                            <div id="changeRequestSuccess" style="display:none;margin-top:12px;padding:10px 14px;background:#d4edda;color:#155724;border-radius:4px;font-size:13px;font-weight:500">Your change request has been sent. We'll follow up shortly.</div>
                        </div>
                    </div>

                    <!-- Finalize -->
                    <div class="finalize-section" style="flex-direction:column;align-items:flex-start;gap:8px">
                        <button class="finalize-btn" id="finalizeBtn" onclick="handleFinalize()">Finalize Quote Template</button>
                        <div class="finalize-note">A formal quote document will be created and emailed to you.</div>
                        <div id="poRequiredMsg" style="display:none;font-size:12px;color:#d9534f;font-weight:500">Please enter your PO Number above before finalizing.</div>
                    </div>
                </div>
            </div>

            <!-- Success -->
            <div class="success-view" id="successView">
                <div class="success-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>
                </div>
                <h2>Quote Finalized</h2>
                <p id="successMessage">Your formal quote has been created and sent to your email.</p>
                <a class="view-quote-link" id="quoteLinkBtn" href="#" target="_blank" style="display:none">View Your Formal Quote</a>

                <!-- PO Upload Section -->
                <div class="po-upload-section" id="poUploadSection" style="display:none">
                    <h3 style="font-size:16px;font-weight:700;color:#33475b;margin-bottom:6px">Submit Your Purchase Order</h3>
                    <p style="font-size:13px;color:#7c98b6;margin-bottom:16px">Upload your signed PO document to get production started.</p>

                    <!-- Already uploaded state -->
                    <div id="poAlreadyUploaded" style="display:none">
                        <div class="po-received-badge">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>
                            PO received on <span id="poReceivedDateText"></span>
                        </div>
                        <p style="font-size:12px;color:#7c98b6;margin-top:10px">
                            Need to submit an updated PO? <a href="#" id="reuploadLink" style="color:#4C76B8;text-decoration:none;font-weight:500">Upload a new version</a>
                        </p>
                    </div>

                    <!-- Upload area -->
                    <div id="poUploadArea">
                        <div class="upload-dropzone" id="poDropzone">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="display:block;margin:0 auto 8px"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                            <div>Drag &amp; drop your PO here, or <span style="color:#4C76B8;text-decoration:underline">browse</span></div>
                            <div style="font-size:11px;color:#99acc2;margin-top:4px">PDF, PNG, or JPG (max 3MB)</div>
                        </div>
                        <input type="file" id="poFileInput" accept=".pdf,.png,.jpg,.jpeg" style="display:none">

                        <!-- Selected file display -->
                        <div class="po-file-display" id="poFileDisplay" style="display:none">
                            <span id="poFileName"></span>
                            <span class="po-file-remove" id="poFileRemove">Remove</span>
                        </div>

                        <!-- Progress bar -->
                        <div id="poProgress" style="display:none">
                            <div class="upload-progress"><div class="upload-progress-bar" id="poProgressBar"></div></div>
                            <div id="poProgressText" style="font-size:12px;color:#7c98b6;margin-top:6px;text-align:center">Uploading...</div>
                        </div>

                        <!-- Upload button -->
                        <button class="upload-btn" id="poUploadBtn" style="display:none" disabled>Upload PO</button>
                    </div>

                    <!-- Upload success -->
                    <div id="poUploadSuccess" style="display:none">
                        <div class="po-received-badge">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>
                            We've received your PO, thank you!
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var urlParams = new URLSearchParams(window.location.search);
        var dealId = urlParams.get('dealId');
        var token = urlParams.get('token');
        var dealData = null;

        if (!dealId || !token) {
            showError('Invalid link. Please use the link from your email.');
        } else {
            loadData();
        }

        async function loadData() {
            try {
                var res = await fetch('/api/po-quote-review?dealId=' + dealId + '&token=' + token);
                if (res.status === 403) {
                    showError('This link is invalid or has expired. Please contact Show Off Inc. for a new link.');
                    return;
                }
                if (!res.ok) throw new Error('Failed to load quote');
                dealData = await res.json();

                // Already finalized? Show success view with existing quote link + PO upload
                if ((dealData.poQuoteStatus === 'Finalized' || dealData.poQuoteStatus === 'PO Received') && dealData.poQuoteLink) {
                    document.getElementById('loadingView').style.display = 'none';
                    document.getElementById('successMessage').textContent = 'This quote has already been finalized. Your formal quote is ready.';
                    var linkBtn = document.getElementById('quoteLinkBtn');
                    linkBtn.href = dealData.poQuoteLink;
                    linkBtn.style.display = 'inline-block';
                    document.getElementById('successView').style.display = 'block';
                    showPoSection(dealData);
                    return;
                }

                var v = dealData.verbiage || {};

                // Quote/order reference number
                var dealNum = (dealData.dealName || '').split(/\s/)[0].trim();
                if (dealNum) {
                    document.getElementById('quoteRef').textContent = 'Ref #' + dealNum;
                }

                // Quote title
                document.getElementById('quoteTitle').value = dealData.poFields.title || dealData.dealName || '';

                // School name
                document.getElementById('schoolName').value = v.schoolName || '';

                // Attention line
                document.getElementById('attentionLine').value = dealData.poFields.addressee || '';

                // Mailing address
                document.getElementById('addrCity').value = v.mailingCity || '';
                document.getElementById('addrState').value = v.mailingState || '';
                document.getElementById('addrZip').value = v.mailingZip || '';
                document.getElementById('addrCountry').value = v.mailingCountry || 'United States';

                // Dates — use real sent date from API
                var sentDate = dealData.sentDate ? new Date(dealData.sentDate + 'T12:00:00') : new Date();
                document.getElementById('createdDate').textContent = 'Quote sent: ' + formatDateLong(sentDate);
                document.getElementById('expiresDate').textContent = 'Quote expires: ' + formatDateLong(new Date(dealData.expirationDate + 'T12:00:00'));

                // Comments
                document.getElementById('quoteNotes').value = dealData.poFields.notes || '';

                // Send-to email — payer first (if exists), then primary contact
                var defaultEmail = '';
                if (dealData.payerContact && dealData.payerContact.email) {
                    defaultEmail = dealData.payerContact.email;
                } else if (dealData.primaryContact && dealData.primaryContact.email) {
                    defaultEmail = dealData.primaryContact.email;
                }
                document.getElementById('sendToEmail').value = defaultEmail;

                // Line items
                var tbody = document.getElementById('itemsBody');
                if (!dealData.lineItems || dealData.lineItems.length === 0) {
                    var tr = document.createElement('tr');
                    tr.innerHTML = '<td colspan="4" style="text-align:center;color:#7c98b6;padding:24px 0;font-style:italic">No items have been added to this quote yet. Please contact us at <a href="mailto:support@showoffinc.com" style="color:#4C76B8">support@showoffinc.com</a>.</td>';
                    tbody.appendChild(tr);
                } else {
                    dealData.lineItems.forEach(function(item) {
                        var lineTotal = item.quantity * item.price;
                        var tr = document.createElement('tr');
                        tr.innerHTML =
                            '<td>' + esc(item.name) + '</td>' +
                            '<td class="qty">' + item.quantity + '</td>' +
                            '<td class="price">$' + formatNum(item.price) + '</td>' +
                            '<td class="total">$' + formatNum(lineTotal) + '</td>';
                        tbody.appendChild(tr);
                    });
                }

                // Totals
                var total = dealData.total || 0;
                document.getElementById('subtotalAmount').textContent = '$' + formatNum(total);
                document.getElementById('grandTotal').textContent = '$' + formatNum(total);

                // Purchase terms (from admin verbiage, default "Net 30")
                document.getElementById('purchaseTermsDisplay').textContent = v.purchaseTerms || 'Net 30';

                // PO Number
                document.getElementById('poNumber').value = v.poNumber || '';

                // Show
                document.getElementById('loadingView').style.display = 'none';
                document.getElementById('mainView').style.display = 'block';
            } catch (err) {
                showError('Unable to load your quote. Please try again or contact Show Off Inc.');
            }
        }

        function showError(msg) {
            document.getElementById('loadingView').style.display = 'none';
            document.getElementById('errorMessage').textContent = msg;
            document.getElementById('errorView').style.display = 'block';
        }

        function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

        function formatNum(n) {
            return Number(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatDateLong(d) {
            var months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            return months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
        }

        async function handleFinalize() {
            // Require PO Number
            var poNum = document.getElementById('poNumber').value.trim();
            if (!poNum) {
                document.getElementById('poRequiredMsg').style.display = 'block';
                document.getElementById('poNumber').focus();
                document.getElementById('poNumber').style.borderColor = '#d9534f';
                return;
            }
            document.getElementById('poRequiredMsg').style.display = 'none';
            document.getElementById('poNumber').style.borderColor = '';

            if (!confirm('This will create a formal quote document and email it to you. This cannot be undone.\n\nContinue?')) return;

            var btn = document.getElementById('finalizeBtn');
            btn.disabled = true;
            btn.textContent = 'Finalizing...';

            // Collect all presentation fields
            var sendToEmail = document.getElementById('sendToEmail').value;
            var payload = {
                dealId: dealId,
                token: token,
                // Existing PO fields
                quoteTitle: document.getElementById('quoteTitle').value || dealData.dealName,
                addressee: document.getElementById('attentionLine').value,
                quoteNotes: document.getElementById('quoteNotes').value,
                poNumber: document.getElementById('poNumber').value,
                // Verbiage fields (presentation-only)
                verbiage: {
                    schoolName: document.getElementById('schoolName').value,
                    mailingCity: document.getElementById('addrCity').value,
                    mailingState: document.getElementById('addrState').value,
                    mailingZip: document.getElementById('addrZip').value,
                    mailingCountry: document.getElementById('addrCountry').value,
                    poNumber: document.getElementById('poNumber').value
                },
                // Contact — uses editable email, falls back to payer then primary
                contactEmail: sendToEmail || (dealData.payerContact ? dealData.payerContact.email : (dealData.primaryContact ? dealData.primaryContact.email : null)),
                contactName: (dealData.payerContact ? dealData.payerContact.name : null) || (dealData.primaryContact ? dealData.primaryContact.name : null),
                contactId: (dealData.payerContact ? dealData.payerContact.id : null) || (dealData.primaryContact ? dealData.primaryContact.id : null),
                // CC recipients
                ccEmails: document.getElementById('ccEmails').value
            };

            try {
                var res = await fetch('https://showoffinc.app.n8n.cloud/webhook/finalize-po-quote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                var data = await res.json();

                if (res.ok && data.success) {
                    document.getElementById('mainView').style.display = 'none';

                    if (data.quoteLink) {
                        var linkBtn = document.getElementById('quoteLinkBtn');
                        linkBtn.href = data.quoteLink;
                        linkBtn.style.display = 'inline-block';
                    }

                    var msg;
                    if (data.alreadyFinalized) {
                        msg = 'This quote was already finalized. Your formal quote is ready.';
                    } else {
                        msg = 'Your formal quote has been created';
                        if (sendToEmail) {
                            msg += ' and sent to ' + sendToEmail;
                        }
                        var cc = document.getElementById('ccEmails').value.trim();
                        if (cc) {
                            msg += ' (CC: ' + cc + ')';
                        }
                        msg += '.';
                    }
                    document.getElementById('successMessage').textContent = msg;
                    document.getElementById('successView').style.display = 'block';
                    if (!data.alreadyFinalized) showPoSection(dealData);
                } else {
                    throw new Error(data.error || 'Server error');
                }
            } catch (err) {
                alert('Error finalizing quote: ' + err.message + '. Please try again.');
                btn.disabled = false;
                btn.textContent = 'Finalize Quote';
            }
        }
        // ── Request Changes Functions ──

        function toggleChangeRequest() {
            var form = document.getElementById('changeRequestForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        function sendChangeRequest() {
            var msg = document.getElementById('changeRequestText').value.trim();
            if (!msg) { alert('Please describe what you\'d like changed.'); return; }

            var dealNum = (dealData.dealName || '').split(/\s/)[0].trim();
            var subject = encodeURIComponent('Change Request — Quote #' + dealNum);
            var body = encodeURIComponent('Re: Quote #' + dealNum + '\n\n' + msg + '\n');
            window.location.href = 'mailto:support@showoffinc.com?subject=' + subject + '&body=' + body;
        }

        // ── PO Upload Functions ──

        var poFile = null;

        function showPoSection(data) {
            var section = document.getElementById('poUploadSection');
            section.style.display = 'block';

            if (data.poDocumentUrl && data.poReceivedDate) {
                // Already uploaded — show received badge
                document.getElementById('poAlreadyUploaded').style.display = 'block';
                document.getElementById('poUploadArea').style.display = 'none';
                try {
                    document.getElementById('poReceivedDateText').textContent = formatDateLong(new Date(data.poReceivedDate + 'T12:00:00'));
                } catch(e) {
                    document.getElementById('poReceivedDateText').textContent = data.poReceivedDate;
                }
            } else {
                // Show upload area
                document.getElementById('poAlreadyUploaded').style.display = 'none';
                document.getElementById('poUploadArea').style.display = 'block';
            }
        }

        function fileToBase64(file) {
            return new Promise(function(resolve, reject) {
                var reader = new FileReader();
                reader.onload = function() { resolve(reader.result); };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function handlePoFile(files) {
            if (!files || !files.length) return;
            var file = files[0];
            var maxSize = 3 * 1024 * 1024;
            var allowedTypes = ['application/pdf', 'image/png', 'image/jpeg'];

            if (!allowedTypes.includes(file.type)) {
                alert('Please upload a PDF, PNG, or JPG file.');
                return;
            }
            if (file.size > maxSize) {
                alert('File is too large (max 3MB). If your PO is larger, please email it to support@showoffinc.com.');
                return;
            }

            poFile = file;
            document.getElementById('poFileName').textContent = file.name + ' (' + (file.size / 1024 / 1024).toFixed(1) + ' MB)';
            document.getElementById('poFileDisplay').style.display = 'flex';
            document.getElementById('poUploadBtn').style.display = 'inline-block';
            document.getElementById('poUploadBtn').disabled = false;
        }

        function clearPoFile() {
            poFile = null;
            document.getElementById('poFileInput').value = '';
            document.getElementById('poFileDisplay').style.display = 'none';
            document.getElementById('poUploadBtn').style.display = 'none';
        }

        async function handlePoUpload() {
            if (!poFile) return;

            var btn = document.getElementById('poUploadBtn');
            btn.disabled = true;
            btn.textContent = 'Uploading...';
            document.getElementById('poProgress').style.display = 'block';
            document.getElementById('poProgressBar').style.width = '30%';

            try {
                var base64 = await fileToBase64(poFile);
                document.getElementById('poProgressBar').style.width = '60%';

                var res = await fetch('/api/upload-po', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dealId: dealId,
                        token: token,
                        fileName: poFile.name,
                        fileType: poFile.type,
                        fileData: base64
                    })
                });

                document.getElementById('poProgressBar').style.width = '90%';
                var data = await res.json();

                if (res.ok && data.success) {
                    document.getElementById('poProgressBar').style.width = '100%';
                    setTimeout(function() {
                        document.getElementById('poUploadArea').style.display = 'none';
                        document.getElementById('poUploadSuccess').style.display = 'block';
                    }, 300);
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (err) {
                alert('Error uploading PO: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'Upload PO';
                document.getElementById('poProgress').style.display = 'none';
                document.getElementById('poProgressBar').style.width = '0';
            }
        }

        // Wire up event listeners
        (function() {
            var dropzone = document.getElementById('poDropzone');
            var fileInput = document.getElementById('poFileInput');
            var uploadBtn = document.getElementById('poUploadBtn');
            var removeBtn = document.getElementById('poFileRemove');
            var reuploadLink = document.getElementById('reuploadLink');

            dropzone.addEventListener('click', function() { fileInput.click(); });
            fileInput.addEventListener('change', function() { handlePoFile(this.files); });
            uploadBtn.addEventListener('click', handlePoUpload);
            removeBtn.addEventListener('click', clearPoFile);
            reuploadLink.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('poAlreadyUploaded').style.display = 'none';
                document.getElementById('poUploadArea').style.display = 'block';
                document.getElementById('poUploadSuccess').style.display = 'none';
            });

            dropzone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropzone.classList.add('dragover');
            });
            dropzone.addEventListener('dragleave', function() {
                dropzone.classList.remove('dragover');
            });
            dropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                handlePoFile(e.dataTransfer.files);
            });
        })();
    </script>
</body>
</html>
